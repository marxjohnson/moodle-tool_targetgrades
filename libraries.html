<p><html>
    <head>
        <link rel="stylesheet" type="text/css" href="pyg.css" />
        <title>Target Grades - Libraries</title>
    </head>
    <body></p>
<h1>Target Grades</h1>
<h2>Libraries</h2>
<ul>
<li><a href="#classes">Classes</a><br />
</li>
<li><a href="#constants">Constants</a><br />
</li>
<li><a href="#exceptions">Exceptions</a><br />
</li>
<li><a href="#forms">Forms</a><br />
</li>
<li><a href="#functions">Functions</a> </li>
</ul>
<p>The Target Grades report contains 2 libraries - <code>lib.php</code> and <code>alisdata_form.php</code>. These define all the constants, functions and classes used in the system.</p>
<p>These libraries define everything within the reporttargetgrades namespace:</p>
<div class="highlight"><pre><a name="l-1"></a><span class="k">namespace</span> <span class="nx">report\targetgrades</span><span class="p">;</span>
</pre></div>

<p>This allows the definitions to be given reasonable concise names without the risk of name collisions with other parts of Moodle.  All files that include these libaraies alias the namespace to <code>tg</code> using the following line:</p>
<div class="highlight"><pre><a name="l-1"></a><span class="k">use</span> <span class="nx">report\targetgrades</span> <span class="k">as</span> <span class="nx">tg</span><span class="p">;</span>
</pre></div>

<p>Functions from the library can then be called using the following syntax:</p>
<div class="highlight"><pre><a name="l-1"></a><span class="nv">$config</span> <span class="o">=</span> <span class="nx">tg\get_config</span><span class="p">();</span>
</pre></div>

<h3><a name="constants">Constants</a></h3>
<h4>Qualifications</h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">const</span> <span class="no">ALIS_GCSE</span> <span class="o">=</span> <span class="s1">&#39;GCSE&#39;</span><span class="p">;</span>
<a name="l-2"></a><span class="k">const</span> <span class="no">ALIS_ADVANCED_GCE</span> <span class="o">=</span> <span class="s1">&#39;Advanced GCE&#39;</span><span class="p">;</span>
<a name="l-3"></a><span class="k">const</span> <span class="no">ALIS_ADVANCED_GCE_DOUBLE</span> <span class="o">=</span> <span class="s1">&#39;Advanced GCE (Double Award)&#39;</span><span class="p">;</span>
<a name="l-4"></a><span class="k">const</span> <span class="no">ALIS_ADVANCED_SUBSIDIARY_GCE</span> <span class="o">=</span> <span class="s1">&#39;Advanced Subsidiary GCE&#39;</span><span class="p">;</span>
<a name="l-5"></a><span class="k">const</span> <span class="no">ALIS_ADVANCED_SUBSIDIARY_GCE_DOUBLE</span> <span class="o">=</span> <span class="s1">&#39;Advanced Subsidiary GCE (Double Award)&#39;</span><span class="p">;</span>
<a name="l-6"></a><span class="k">const</span> <span class="no">ALIS_INTERMEDIATE_GNVQ</span> <span class="o">=</span> <span class="s1">&#39;Intermediate GNVQ&#39;</span><span class="p">;</span>
<a name="l-7"></a><span class="k">const</span> <span class="no">ALIS_IB_STANDARD</span> <span class="o">=</span> <span class="s1">&#39;IB Standard&#39;</span><span class="p">;</span>
<a name="l-8"></a><span class="k">const</span> <span class="no">ALIS_IB_HIGHER</span> <span class="o">=</span> <span class="s1">&#39;IB Higher&#39;</span><span class="p">;</span>
<a name="l-9"></a><span class="k">const</span> <span class="no">ALIS_CACHE_L3_DIPLOMA</span> <span class="o">=</span> <span class="s1">&#39;CACHE Level 3 Diploma&#39;</span><span class="p">;</span>
<a name="l-10"></a><span class="k">const</span> <span class="no">ALIS_OCR_NATIONAL_CERTIFICATE</span> <span class="o">=</span> <span class="s1">&#39;OCR National Certificate&#39;</span><span class="p">;</span>
<a name="l-11"></a><span class="k">const</span> <span class="no">ALIS_OCR_NATIONAL_DIPLOMA</span> <span class="o">=</span> <span class="s1">&#39;OCR National Diploma&#39;</span><span class="p">;</span>
<a name="l-12"></a><span class="k">const</span> <span class="no">ALIS_BTEC_NATIONAL_AWARD</span> <span class="o">=</span> <span class="s1">&#39;BTEC National Award&#39;</span><span class="p">;</span>
<a name="l-13"></a><span class="k">const</span> <span class="no">ALIS_BTEC_NATIONAL_CERTIFICATE</span> <span class="o">=</span> <span class="s1">&#39;BTEC National Certificate&#39;</span><span class="p">;</span>
<a name="l-14"></a><span class="k">const</span> <span class="no">ALIS_BTEC_NATIONAL_DIPLOMA</span> <span class="o">=</span> <span class="s1">&#39;BTEC National Diploma&#39;</span><span class="p">;</span>
<a name="l-15"></a><span class="k">const</span> <span class="no">ALIS_BTEC_FIRST_DIPLOMA</span> <span class="o">=</span> <span class="s1">&#39;BTEC First Diploma&#39;</span><span class="p">;</span>
</pre></div>

<p>These constants define the names of the Qualifications tracked by ALIS, as they appear in the ALIS equations PDF.  They are used to set the names in the qualtypes table, and to determine the qualification type of a particular course.</p>
<h4>Scales</h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">const</span> <span class="no">MTG_SCALE_GCSE</span> <span class="o">=</span> <span class="s1">&#39;U,G,F,E,D,C,B,A,A*&#39;</span><span class="p">;</span>
<a name="l-2"></a><span class="k">const</span> <span class="no">MTG_SCALE_ADVANCED_GCE</span> <span class="o">=</span> <span class="s1">&#39;U,E,D,C,B,A,A*&#39;</span><span class="p">;</span>
<a name="l-3"></a><span class="k">const</span> <span class="no">MTG_SCALE_ADVANCED_SUBSIDIARY_GCE</span> <span class="o">=</span> <span class="s1">&#39;U,E,D,C,B,A,A*&#39;</span><span class="p">;</span>
<a name="l-4"></a><span class="k">const</span> <span class="no">MTG_SCALE_BTEC_AWARD</span> <span class="o">=</span> <span class="s1">&#39;Fail,Pass,Merit,Distinction&#39;</span><span class="p">;</span>
<a name="l-5"></a><span class="k">const</span> <span class="no">MTG_SCALE_BTEC_CERTIFICATE</span> <span class="o">=</span> <span class="s1">&#39;Fail,PP,MP,MM,DM,DD&#39;</span><span class="p">;</span>
<a name="l-6"></a><span class="k">const</span> <span class="no">MTG_SCALE_BTEC_DIPLOMA</span> <span class="o">=</span> <span class="s1">&#39;Fail,PPP,MPP,MMP,MMM,DMM,DDM,DDD&#39;</span><span class="p">;</span>
<a name="l-7"></a><span class="k">const</span> <span class="no">MTG_SCALE_ADVANCED_GCE_DOUBLE</span> <span class="o">=</span> <span class="s1">&#39;U,EE,DE,DD,CD,CC,BC,BB,AB,AA,A*A,A*A*&#39;</span><span class="p">;</span>
<a name="l-8"></a><span class="k">const</span> <span class="no">MTG_SCALE_ADVANCED_SUBSIDIARY_GCE_DOUBLE</span> <span class="o">=</span> <span class="s1">&#39;U,EE,DE,DD,CD,CC,BC,BB,AB,AA,A*A,A*A*&#39;</span><span class="p">;</span>
<a name="l-9"></a><span class="k">const</span> <span class="no">MTG_SCALE_IB</span> <span class="o">=</span> <span class="s1">&#39;1,2,3,4,5,6,7&#39;</span><span class="p">;</span>
</pre></div>

<p>These constants are used to define the scales used for each of the qualifications tracked by ALIS.  These scales are entered into the scales table when the report is installed, and used to set the scale for the target grade items.</p>
<h4>Correlation</h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">const</span> <span class="no">CORRELATION_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>
</pre></div>

<p>This is the threshold used by quality checks to determine whether the correlation of a set of statistics is reliable enough to be used for calculations.  Below this number, the statistics will be flagged as having low correlation.  According the the ALIS equations PDF, a correlation of 0.6-0.7 is considered to be strong.</p>
<h4>Grade Items</h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">const</span> <span class="no">GRADE_ITEM_PREFIX</span> <span class="o">=</span> <span class="s1">&#39;targetgrades_&#39;</span><span class="p">;</span>
</pre></div>

<p>This string is used to prefix the idnumber of each grade item generated during distribution.  It's then used by <a href="#sort_gradebook">sort_gradebook()</a> to find the items for sorting.</p>
<h3><a name="functions">Functions</a></h3>
<ul>
<li><a href="#build_pattern_options">build_pattern_options()</a><br />
</li>
<li><a href="#calulate_mtg">calulate_mtg()</a><br />
</li>
<li><a href="#get_config">get_config()</a><br />
</li>
<li><a href="#get_scale">get_scale()</a><br />
</li>
<li><a href="#hasconfig">hasconfig()</a><br />
</li>
<li><a href="#print_tabs">print_tabs()</a><br />
</li>
<li><a href="#sort_gradebook">sort_gradebook()</a> </li>
</ul>
<h4><a name="get_scale">get_scale()</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">function</span> <span class="nf">get_scale</span><span class="p">(</span><span class="nv">$qualtype</span><span class="p">)</span> <span class="p">{</span>
<a name="l-2"></a>    <span class="k">switch</span> <span class="p">(</span><span class="nv">$qualtype</span><span class="p">)</span> <span class="p">{</span>
<a name="l-3"></a>        <span class="k">case</span> <span class="nx">ALIS_GCSE</span><span class="o">:</span>
<a name="l-4"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_GCSE</span><span class="p">;</span>
<a name="l-5"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-6"></a>
<a name="l-7"></a>        <span class="k">case</span> <span class="nx">ALIS_ADVANCED_GCE</span><span class="o">:</span>
<a name="l-8"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_ADVANCED_GCE</span><span class="p">;</span>
<a name="l-9"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-10"></a>
<a name="l-11"></a>        <span class="k">case</span> <span class="nx">ALIS_ADVANCED_GCE_DOUBLE</span><span class="o">:</span>
<a name="l-12"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_ADVANCED_GCE_DOUBLE</span><span class="p">;</span>
<a name="l-13"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-14"></a>
<a name="l-15"></a>        <span class="k">case</span> <span class="nx">ALIS_ADVANCED_SUBSIDIARY_GCE</span><span class="o">:</span>
<a name="l-16"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_ADVANCED_SUBSIDIARY_GCE</span><span class="p">;</span>
<a name="l-17"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-18"></a>
<a name="l-19"></a>        <span class="k">case</span> <span class="nx">ALIS_ADVANCED_SUBSIDIARY_GCE_DOUBLE</span><span class="o">:</span>
<a name="l-20"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_ADVANCED_SUBSIDIARY_GCE_DOUBLE</span><span class="p">;</span>
<a name="l-21"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-22"></a>
<a name="l-23"></a>        <span class="k">case</span> <span class="nx">ALIS_INTERMEDIATE_GNVQ</span><span class="o">:</span>
<a name="l-24"></a>            <span class="c1">// TODO: Work out what this should be</span>
<a name="l-25"></a>            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<a name="l-26"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-27"></a>
<a name="l-28"></a>        <span class="k">case</span> <span class="nx">ALIS_IB_STANDARD</span><span class="o">:</span>
<a name="l-29"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_IB</span><span class="p">;</span>
<a name="l-30"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-31"></a>
<a name="l-32"></a>        <span class="k">case</span> <span class="nx">ALIS_IB_HIGHER</span><span class="o">:</span>
<a name="l-33"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_IB</span><span class="p">;</span>
<a name="l-34"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-35"></a>
<a name="l-36"></a>        <span class="k">case</span> <span class="nx">ALIS_CACHE_L3_DIPLOMA</span><span class="o">:</span>
<a name="l-37"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_ADVANCED_SUBSIDIARY_GCE</span><span class="p">;</span>
<a name="l-38"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-39"></a>
<a name="l-40"></a>        <span class="k">case</span> <span class="nx">ALIS_OCR_NATIONAL_CERTIFICATE</span><span class="o">:</span>
<a name="l-41"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_BTEC_AWARD</span><span class="p">;</span>
<a name="l-42"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-43"></a>
<a name="l-44"></a>        <span class="k">case</span> <span class="nx">ALIS_OCR_NATIONAL_DIPLOMA</span><span class="o">:</span>
<a name="l-45"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_BTEC_CERTIFICATE</span><span class="p">;</span>
<a name="l-46"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-47"></a>
<a name="l-48"></a>        <span class="k">case</span> <span class="nx">ALIS_BTEC_NATIONAL_AWARD</span><span class="o">:</span>
<a name="l-49"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_BTEC_AWARD</span><span class="p">;</span>
<a name="l-50"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-51"></a>
<a name="l-52"></a>        <span class="k">case</span> <span class="nx">ALIS_BTEC_NATIONAL_CERTIFICATE</span><span class="o">:</span>
<a name="l-53"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_BTEC_CERTIFICATE</span><span class="p">;</span>
<a name="l-54"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-55"></a>
<a name="l-56"></a>        <span class="k">case</span> <span class="nx">ALIS_BTEC_NATIONAL_DIPLOMA</span><span class="o">:</span>
<a name="l-57"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_BTEC_DIPLOMA</span><span class="p">;</span>
<a name="l-58"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-59"></a>
<a name="l-60"></a>        <span class="k">case</span> <span class="nx">ALIS_BTEC_FIRST_DIPLOMA</span><span class="o">:</span>
<a name="l-61"></a>            <span class="k">return</span> <span class="nx">MTG_SCALE_BTEC_AWARD</span><span class="p">;</span>
<a name="l-62"></a>            <span class="k">break</span><span class="p">;</span>
<a name="l-63"></a>    <span class="p">}</span>
<a name="l-64"></a><span class="p">}</span>
</pre></div>

<p><code>get_scale()</code> basically just takes one of the ALIS qualification constants and return the constant for the scale the that qualification uses.  The name of the scale constant doesn't necessarily match the name of the qualification, since some qualifications use identical scales so the scale is only defined once.</p>
<h4><a name="get_config">get_config()</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">function</span> <span class="nf">get_config</span><span class="p">(</span><span class="nv">$force</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
<a name="l-2"></a>    <span class="k">static</span> <span class="nv">$config</span><span class="p">;</span>
<a name="l-3"></a>    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$force</span><span class="p">)</span> <span class="p">{</span>
<a name="l-4"></a>        <span class="nv">$config</span> <span class="o">=</span> <span class="nx">\get_config</span><span class="p">(</span><span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-5"></a>        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">categories</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">categories</span><span class="p">)</span> <span class="o">?</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">categories</span><span class="p">)</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span>
<a name="l-6"></a>        <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">roles</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">)</span> <span class="o">?</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">)</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span>
<a name="l-7"></a>    <span class="p">}</span>
<a name="l-8"></a>    <span class="k">return</span> <span class="nv">$config</span><span class="p">;</span>
<a name="l-9"></a><span class="p">}</span>
</pre></div>

<p><code>get_config()</code> uses Moodle's own <code>get_config()</code> function (note the  denoting that it's in the global namespace) to get the configuration settings for the plugin.  It then uses <code>unserialize()</code> to get the roles and categories settings as arrays.</p>
<p>By default, the config will only be loaded once per page, so if several functions call <code>get_config()</code> only the first one will require any database queries - subsequent calls will just return the inital result.  This can be overridden by setting the <code>$force</code> paramter to <code>true</code>, for example if the config is changed within the page and an up-to-date copy is required.</p>
<h4><a name="hasconfig">hasconfig()</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">function</span> <span class="nf">hasconfig</span><span class="p">(</span><span class="nv">$options</span><span class="p">){</span>
<a name="l-2"></a>     <span class="nb">array_walk</span><span class="p">(</span><span class="nv">$options</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$option</span><span class="p">){</span> <span class="c1">// Mark all courses that don&#39;t have any ALIS data</span>
<a name="l-3"></a>        <span class="k">global</span> <span class="nv">$DB</span><span class="p">;</span>
<a name="l-4"></a>        <span class="nv">$select</span> <span class="o">=</span> <span class="s1">&#39;SELECT * &#39;</span><span class="p">;</span>
<a name="l-5"></a>        <span class="nv">$from</span> <span class="o">=</span> <span class="s1">&#39;FROM {report_targetgrades_patterns} p</span>
<a name="l-6"></a><span class="s1">            JOIN {report_targetgrades_alisdata} d ON p.alisdataid = d.id &#39;</span><span class="p">;</span>
<a name="l-7"></a>        <span class="nv">$where</span> <span class="o">=</span> <span class="s1">&#39;WHERE p.pattern = ?&#39;</span><span class="p">;</span>
<a name="l-8"></a>        <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$option</span><span class="o">-&gt;</span><span class="na">pattern</span><span class="p">);</span>
<a name="l-9"></a>        <span class="k">if</span><span class="p">(</span><span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record_sql</span><span class="p">(</span><span class="nv">$select</span><span class="o">.</span><span class="nv">$from</span><span class="o">.</span><span class="nv">$where</span><span class="p">,</span> <span class="nv">$params</span><span class="p">))</span> <span class="p">{</span>
<a name="l-10"></a>            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<a name="l-11"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-12"></a>            <span class="nv">$option</span><span class="o">-&gt;</span><span class="na">firstname</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>
<a name="l-13"></a>        <span class="p">}</span>
<a name="l-14"></a>    <span class="p">});</span>
<a name="l-15"></a>    <span class="k">return</span> <span class="nv">$options</span><span class="p">;</span>
<a name="l-16"></a><span class="p">}</span>
</pre></div>

<p><code>hasconfig()</code> takes an array of courses, and determines whether each one has been configured to use a set of ALIS statistics for calculations.  If there aren't any, it sets the <code>firstname</code> field of the item to an asterisk so this fact can be indicated on screen.  For an explanation of the weird field name used here, see the <code>[potential_course_selector](#pcs)</code>.</p>
<h4><a name="calulate_mtg">calulate_mtg()</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">function</span> <span class="nf">calculate_mtg</span><span class="p">(</span><span class="nv">$student</span><span class="p">,</span> <span class="nv">$course</span><span class="p">){</span>
<a name="l-2"></a>    <span class="k">global</span> <span class="nv">$DB</span><span class="p">;</span>
<a name="l-3"></a>    <span class="nv">$select</span> <span class="o">=</span> <span class="s1">&#39;SELECT name, gradient, intercept &#39;</span><span class="p">;</span>
<a name="l-4"></a>    <span class="nv">$from</span> <span class="o">=</span> <span class="s1">&#39;FROM {report_targetgrades_patterns} AS p</span>
<a name="l-5"></a><span class="s1">        JOIN {report_targetgrades_alisdata} AS d ON p.alisdataid = d.id &#39;</span><span class="p">;</span>
<a name="l-6"></a>    <span class="nv">$where</span> <span class="o">=</span> <span class="s1">&#39;WHERE p.pattern = ?&#39;</span><span class="p">;</span>
<a name="l-7"></a>    <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">pattern</span><span class="p">);</span>
<a name="l-8"></a>
<a name="l-9"></a>    <span class="k">if</span><span class="p">(</span><span class="nv">$alis</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record_sql</span><span class="p">(</span><span class="nv">$select</span><span class="o">.</span><span class="nv">$from</span><span class="o">.</span><span class="nv">$where</span><span class="p">,</span> <span class="nv">$params</span><span class="p">))</span> <span class="p">{</span>
<a name="l-10"></a>        <span class="nv">$points</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$student</span><span class="o">-&gt;</span><span class="na">avgcse</span> <span class="o">*</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">gradient</span><span class="p">)</span><span class="o">+</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">intercept</span><span class="p">;</span>
<a name="l-11"></a>
<a name="l-12"></a>        <span class="c1">// Calculate UCAS points using ALIS formula</span>
<a name="l-13"></a>
<a name="l-14"></a>        <span class="k">switch</span><span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">qualtype</span><span class="p">)</span> <span class="p">{</span>
<a name="l-15"></a>            <span class="c1">// Calculate grade value based on course type</span>
<a name="l-16"></a>
<a name="l-17"></a>            <span class="k">case</span> <span class="nx">ALIS_ADVANCED_GCE</span><span class="o">:</span> <span class="c1">// A2</span>
<a name="l-18"></a>                <span class="c1">// Divide points score by 2</span>
<a name="l-19"></a>                <span class="c1">// Divide by 10</span>
<a name="l-20"></a>                <span class="c1">// Round Up</span>
<a name="l-21"></a>                <span class="nv">$mtg</span> <span class="o">=</span> <span class="nx">\ceil</span><span class="p">(((</span><span class="nv">$points</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
<a name="l-22"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-23"></a>
<a name="l-24"></a>            <span class="k">case</span> <span class="nx">ALIS_ADVANCED_GCE_DOUBLE</span><span class="o">:</span> <span class="c1">// A2 Double Award</span>
<a name="l-25"></a>                <span class="c1">// Divide points score by 2</span>
<a name="l-26"></a>                <span class="c1">// Minus 20</span>
<a name="l-27"></a>                <span class="c1">// Divide by 10</span>
<a name="l-28"></a>                <span class="c1">// Round Up</span>
<a name="l-29"></a>                <span class="nv">$mtg</span> <span class="o">=</span> <span class="nx">\ceil</span><span class="p">(((</span><span class="nv">$points</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">20</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
<a name="l-30"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-31"></a>
<a name="l-32"></a>            <span class="k">case</span> <span class="nx">ALIS_ADVANCED_SUBSIDIARY_GCE</span><span class="o">:</span> <span class="c1">// AS</span>
<a name="l-33"></a>                <span class="c1">// Minus 20</span>
<a name="l-34"></a>                <span class="c1">// Divide by 10</span>
<a name="l-35"></a>                <span class="c1">// Round Up</span>
<a name="l-36"></a>                <span class="nv">$mtg</span> <span class="o">=</span> <span class="nx">\ceil</span><span class="p">(</span><span class="nv">$points</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
<a name="l-37"></a>
<a name="l-38"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-39"></a>
<a name="l-40"></a>            <span class="k">case</span> <span class="nx">ALIS_ADVANCED_SUBSIDIARY_GCE_DOUBLE</span><span class="o">:</span> <span class="c1">// AS Double Award</span>
<a name="l-41"></a>                <span class="c1">// Divide by 10</span>
<a name="l-42"></a>                <span class="c1">// Round Up</span>
<a name="l-43"></a>                <span class="nv">$mtg</span> <span class="o">=</span> <span class="nx">\ceil</span><span class="p">((</span><span class="nv">$points</span><span class="o">-</span><span class="mi">20</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
<a name="l-44"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-45"></a>
<a name="l-46"></a>            <span class="k">case</span> <span class="nx">ALIS_BTEC_NATIONAL_DIPLOMA</span><span class="o">:</span> <span class="c1">// BTEC Diploma</span>
<a name="l-47"></a>                <span class="c1">// Add 30</span>
<a name="l-48"></a>                <span class="c1">// Minus 100</span>
<a name="l-49"></a>                <span class="c1">// Divide by 40</span>
<a name="l-50"></a>                <span class="c1">// Round up</span>
<a name="l-51"></a>                <span class="c1">// Add 1 (scale includes Fail)</span>
<a name="l-52"></a>                <span class="nv">$mtg</span> <span class="o">=</span> <span class="nx">\ceil</span><span class="p">(((</span><span class="nv">$points</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span><span class="o">-</span><span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="mi">40</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="l-53"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-54"></a>
<a name="l-55"></a>            <span class="k">case</span> <span class="nx">ALIS_BTEC_NATIONAL_CERTIFICATE</span><span class="o">:</span> <span class="c1">// BTEC Certificate</span>
<a name="l-56"></a>                <span class="nv">$mtg</span> <span class="o">=</span> <span class="nx">\ceil</span><span class="p">(</span><span class="nv">$points</span><span class="o">/</span><span class="mi">40</span><span class="p">);</span>
<a name="l-57"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-58"></a>
<a name="l-59"></a>            <span class="k">case</span> <span class="nx">ALIS_BTEC_NATIONAL_AWARD</span><span class="o">:</span> <span class="c1">// BTEC Award</span>
<a name="l-60"></a>                <span class="c1">// Add 10</span>
<a name="l-61"></a>                <span class="c1">// Divide by 40</span>
<a name="l-62"></a>                <span class="c1">// Round up</span>
<a name="l-63"></a>                <span class="c1">// Add 1 (scale includes Fail)</span>
<a name="l-64"></a>                <span class="nv">$mtg</span> <span class="o">=</span> <span class="nx">\ceil</span><span class="p">(</span><span class="nv">$points</span><span class="o">/</span><span class="mi">40</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="l-65"></a>                <span class="k">if</span><span class="p">(</span><span class="nv">$mtg</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
<a name="l-66"></a>                   <span class="nv">$mtg</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<a name="l-67"></a>                <span class="p">}</span>
<a name="l-68"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-69"></a>
<a name="l-70"></a>            <span class="k">case</span> <span class="nx">ALIS_CACHE_L3_DIPLOMA</span><span class="o">:</span> <span class="c1">// CACHE L3 Diploma</span>
<a name="l-71"></a>                <span class="nv">$mtg</span> <span class="o">=</span> <span class="nx">\ceil</span><span class="p">(</span><span class="nv">$points</span><span class="o">/</span><span class="mi">60</span><span class="p">);</span>
<a name="l-72"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-73"></a>
<a name="l-74"></a>             <span class="c1">// These all provide a raw number on the scale, rather than UCAS</span>
<a name="l-75"></a>            <span class="c1">// tariff points.</span>
<a name="l-76"></a>            <span class="k">case</span> <span class="nx">ALIS_IB_STANDARD</span><span class="o">:</span> <span class="c1">// IB</span>
<a name="l-77"></a>            <span class="k">case</span> <span class="nx">ALIS_IB_HIGHER</span><span class="o">:</span> <span class="c1">// IB</span>
<a name="l-78"></a>            <span class="k">case</span> <span class="nx">ALIS_BTEC_FIRST_DIPLOMA</span><span class="o">:</span> <span class="c1">// BTEC 1st</span>
<a name="l-79"></a>            <span class="k">case</span> <span class="nx">ALIS_OCR_NATIONAL_DIPLOMA</span><span class="o">:</span> <span class="c1">// OCR Diploma</span>
<a name="l-80"></a>            <span class="k">case</span> <span class="nx">ALIS_OCR_NATIONAL_CERTIFICATE</span><span class="o">:</span> <span class="c1">// OCR Certificate</span>
<a name="l-81"></a>                <span class="c1">// Add 0.5</span>
<a name="l-82"></a>                <span class="c1">// Round up</span>
<a name="l-83"></a>                <span class="nv">$mtg</span> <span class="o">=</span> <span class="nx">\ceil</span><span class="p">(</span><span class="nv">$points</span><span class="o">+</span><span class="mf">0.5</span><span class="p">);</span>
<a name="l-84"></a>                <span class="k">if</span> <span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">qualtype</span> <span class="o">==</span> <span class="nx">ALIS_BTEC_FIRST_DIPLOMA</span>
<a name="l-85"></a>                        <span class="o">||</span> <span class="nv">$course</span><span class="o">-&gt;</span><span class="na">qualtype</span> <span class="o">==</span> <span class="nx">ALIS_OCR_NATIONAL_DIPLOMA</span>
<a name="l-86"></a>                        <span class="o">||</span>  <span class="nv">$course</span><span class="o">-&gt;</span><span class="na">qualtype</span> <span class="o">==</span> <span class="nx">ALIS_OCR_NATIONAL_CERTIFICATE</span><span class="p">)</span> <span class="p">{</span>
<a name="l-87"></a>                    <span class="c1">// For these 3, add an extra one as the scale includes Fail</span>
<a name="l-88"></a>                    <span class="nv">$mtg</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<a name="l-89"></a>                <span class="p">}</span>
<a name="l-90"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-91"></a>
<a name="l-92"></a>            <span class="k">case</span> <span class="nx">ALIS_GCSE</span><span class="o">:</span> <span class="c1">// GCSE</span>
<a name="l-93"></a>                <span class="c1">// Always a C, since if they&#39;re in FE and taking a GCSE it&#39;s becuase</span>
<a name="l-94"></a>                <span class="c1">// they failed and are trying to pass.</span>
<a name="l-95"></a>                <span class="nv">$mtg</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<a name="l-96"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-97"></a>
<a name="l-98"></a>            <span class="k">default</span><span class="o">:</span>
<a name="l-99"></a>                <span class="nv">$mtg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<a name="l-100"></a>
<a name="l-101"></a>        <span class="p">}</span>
<a name="l-102"></a>
<a name="l-103"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$mtg</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$mtg</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="l-104"></a>            <span class="nv">$mtg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="l-105"></a>        <span class="p">}</span>
<a name="l-106"></a>        <span class="nv">$alis</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="l-107"></a>        <span class="nv">$alis</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$points</span><span class="p">;</span>
<a name="l-108"></a>        <span class="nv">$alis</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$mtg</span><span class="p">;</span>
<a name="l-109"></a>        <span class="k">return</span> <span class="nv">$alis</span><span class="p">;</span>
<a name="l-110"></a>
<a name="l-111"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-112"></a>        <span class="k">throw</span> <span class="k">new</span> <span class="nx">no_mtg_for_student_exception</span><span class="p">(</span><span class="nv">$student</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-113"></a>    <span class="p">}</span>
<a name="l-114"></a>
<a name="l-115"></a><span class="p">}</span>
</pre></div>

<p>This is the function that does "the business" of the plugin.  It takes a student and a course, and calulates a minimum target grade based on the ALIS statistics for that course (if it has been configured to use any).  The inital query gets the statistics that we're using.  Each qualification has to have a slightly different calulation due to the differing scales and grade bounaries, as well as whether the ALIS statistics are based on UCAS tarriff points or just a number on a scale, so we use a switch to determine which to use.  The calulated grade is always rounded up to the next grade boundary (e.g. anything that is calulated between C and B will be rounded up to a B).  The function returns an array containing the raw number produced by the ALIS calulation, and the grade.</p>
<h4><a name="build_pattern_options">build_pattern_options()</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">function</span> <span class="nf">build_pattern_options</span><span class="p">()</span> <span class="p">{</span>
<a name="l-2"></a>
<a name="l-3"></a>    <span class="k">global</span> <span class="nv">$DB</span><span class="p">;</span>
<a name="l-4"></a>    <span class="nv">$config</span> <span class="o">=</span> <span class="nx">get_config</span><span class="p">();</span>
<a name="l-5"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">\preg_match</span><span class="p">(</span><span class="s1">&#39;/(.+?\.?[*+].*?)[*+]/&#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">exclude_regex</span><span class="p">))</span> <span class="p">{</span>
<a name="l-6"></a>        <span class="k">throw</span> <span class="k">new</span> <span class="nx">unsafe_regex_exception</span><span class="p">();</span>
<a name="l-7"></a>    <span class="p">}</span>
<a name="l-8"></a>
<a name="l-9"></a>    <span class="k">list</span><span class="p">(</span><span class="nv">$in_sql</span><span class="p">,</span> <span class="nv">$params</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_in_or_equal</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">categories</span><span class="p">);</span>
<a name="l-10"></a>
<a name="l-11"></a>    <span class="nv">$select</span> <span class="o">=</span> <span class="s1">&#39;SELECT DISTINCT &#39;</span><span class="p">;</span>
<a name="l-12"></a>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_field</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_length</span><span class="p">))</span> <span class="p">{</span>
<a name="l-13"></a>        <span class="nv">$select</span> <span class="o">.=</span> <span class="s1">&#39;LEFT(&#39;</span><span class="o">.</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_field</span><span class="o">.</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_length</span><span class="o">.</span><span class="s1">&#39;),</span>
<a name="l-14"></a><span class="s1">                        LEFT(&#39;</span><span class="o">.</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_field</span><span class="o">.</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_length</span><span class="o">.</span><span class="s1">&#39;) as pattern &#39;</span><span class="p">;</span>
<a name="l-15"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-16"></a>        <span class="nv">$select</span> <span class="o">.=</span> <span class="s1">&#39;shortname, shortname AS pattern &#39;</span><span class="p">;</span>
<a name="l-17"></a>    <span class="p">}</span>
<a name="l-18"></a>
<a name="l-19"></a>    <span class="nv">$from</span> <span class="o">=</span> <span class="s1">&#39;FROM {course} &#39;</span><span class="p">;</span>
<a name="l-20"></a>
<a name="l-21"></a>    <span class="nv">$order</span> <span class="o">=</span> <span class="s1">&#39;ORDER BY pattern&#39;</span><span class="p">;</span>
<a name="l-22"></a>
<a name="l-23"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">sql_regex_supported</span><span class="p">())</span> <span class="p">{</span>
<a name="l-24"></a>        <span class="nv">$where</span> <span class="o">=</span> <span class="s1">&#39;WHERE category &#39;</span><span class="o">.</span><span class="nv">$in_sql</span><span class="o">.</span><span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">exclude_field</span><span class="o">.</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">sql_regex</span><span class="p">(</span><span class="k">false</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39; ? &#39;</span><span class="p">;</span>
<a name="l-25"></a>        <span class="nv">$params</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$params</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">exclude_regex</span><span class="p">));</span>
<a name="l-26"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-27"></a>        <span class="nv">$courses</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_select</span><span class="p">(</span><span class="s1">&#39;course&#39;</span><span class="p">,</span> <span class="s1">&#39;category &#39;</span><span class="o">.</span><span class="nv">$in_sql</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>
<a name="l-28"></a>
<a name="l-29"></a>        <span class="nx">\array_filter</span><span class="p">(</span><span class="nv">$courses</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$course</span><span class="p">,</span> <span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>
<a name="l-30"></a>            <span class="nv">$field</span> <span class="o">=</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">exclude_field</span><span class="p">;</span>
<a name="l-31"></a>            <span class="k">return</span> <span class="o">!</span><span class="nx">\preg_match</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">exclude_regex</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$course</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">);</span>
<a name="l-32"></a>        <span class="p">});</span>
<a name="l-33"></a>
<a name="l-34"></a>        <span class="k">list</span><span class="p">(</span><span class="nv">$in_sql</span><span class="p">,</span> <span class="nv">$params</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_in_or_equal</span><span class="p">(</span><span class="nb">array_keys</span><span class="p">(</span><span class="nv">$courses</span><span class="p">));</span>
<a name="l-35"></a>        <span class="nv">$where</span> <span class="o">=</span> <span class="s1">&#39;WHERE id &#39;</span><span class="o">.</span><span class="nv">$in_sql</span><span class="o">.</span><span class="s1">&#39; &#39;</span><span class="p">;</span>
<a name="l-36"></a>    <span class="p">}</span>
<a name="l-37"></a>
<a name="l-38"></a>    <span class="nv">$where</span> <span class="o">.=</span> <span class="s1">&#39;AND LEFT(&#39;</span><span class="o">.</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_field</span><span class="o">.</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_length</span><span class="o">.</span><span class="s1">&#39;) NOT IN</span>
<a name="l-39"></a><span class="s1">                (SELECT pattern FROM {report_targetgrades_patterns} tp) &#39;</span><span class="p">;</span>
<a name="l-40"></a>
<a name="l-41"></a>    <span class="nv">$options</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_sql_menu</span><span class="p">(</span><span class="nv">$select</span><span class="o">.</span><span class="nv">$from</span><span class="o">.</span><span class="nv">$where</span><span class="o">.</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>
<a name="l-42"></a>
<a name="l-43"></a>    <span class="k">return</span> <span class="nv">$options</span><span class="p">;</span>
<a name="l-44"></a><span class="p">}</span>
</pre></div>

<p>This creates a list of options for matching patterns to a set of statistics, for use on alisdata.php.  Using the <code>group_field</code> and <code>group_length</code> settings, it creates a set of patterns from all the courses in the categories defined by the <code>categories</code> setting, excluding those matched by the <code>exclude_regex</code>.  It then returns the patterns as an array of options to be used for creating a select box.</p>
<h4><a name="sort_gradebook">sort_gradebook()</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">function</span> <span class="nf">sort_gradebook</span><span class="p">(</span><span class="nv">$course</span><span class="p">)</span> <span class="p">{</span>
<a name="l-2"></a>
<a name="l-3"></a>    <span class="k">global</span> <span class="nv">$CFG</span><span class="p">,</span> <span class="nv">$DB</span><span class="p">;</span>
<a name="l-4"></a>    <span class="k">require_once</span> <span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">dirroot</span><span class="o">.</span><span class="s1">&#39;/grade/lib.php&#39;</span><span class="p">;</span>
<a name="l-5"></a>    <span class="k">require_once</span> <span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">dirroot</span><span class="o">.</span><span class="s1">&#39;/grade/edit/tree/lib.php&#39;</span><span class="p">;</span>
<a name="l-6"></a>    <span class="nv">$gtree</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\grade_tree</span><span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
<a name="l-7"></a>
<a name="l-8"></a>    <span class="nv">$fields</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
<a name="l-9"></a>        <span class="nx">GRADE_ITEM_PREFIX</span><span class="o">.</span><span class="s1">&#39;avgcse&#39;</span><span class="p">,</span>
<a name="l-10"></a>        <span class="nx">GRADE_ITEM_PREFIX</span><span class="o">.</span><span class="s1">&#39;alisnum&#39;</span><span class="p">,</span>
<a name="l-11"></a>        <span class="nx">GRADE_ITEM_PREFIX</span><span class="o">.</span><span class="s1">&#39;min&#39;</span><span class="p">,</span>
<a name="l-12"></a>        <span class="nx">GRADE_ITEM_PREFIX</span><span class="o">.</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
<a name="l-13"></a>        <span class="nx">GRADE_ITEM_PREFIX</span><span class="o">.</span><span class="s1">&#39;cpg&#39;</span>
<a name="l-14"></a>    <span class="p">);</span>
<a name="l-15"></a>    <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$course</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-16"></a>    <span class="k">list</span><span class="p">(</span><span class="nv">$in_sql</span><span class="p">,</span> <span class="nv">$in_params</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_in_or_equal</span><span class="p">(</span><span class="nv">$fields</span><span class="p">);</span>
<a name="l-17"></a>    <span class="nv">$params</span> <span class="o">=</span> <span class="nx">\array_merge</span><span class="p">(</span><span class="nv">$params</span><span class="p">,</span> <span class="nv">$in_params</span><span class="p">);</span>
<a name="l-18"></a>    <span class="nv">$where</span> <span class="o">=</span> <span class="s1">&#39;courseid = ? AND idnumber &#39;</span><span class="o">.</span><span class="nv">$in_sql</span><span class="p">;</span>
<a name="l-19"></a>    <span class="nv">$gradeitems</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_select</span><span class="p">(</span><span class="s1">&#39;grade_items&#39;</span><span class="p">,</span> <span class="nv">$where</span><span class="p">,</span> <span class="nv">$params</span><span class="p">,</span> <span class="s1">&#39;itemnumber DESC&#39;</span><span class="p">);</span>
<a name="l-20"></a>    <span class="nv">$courseitem</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record</span><span class="p">(</span><span class="s1">&#39;grade_items&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;courseid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$course</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="s1">&#39;itemtype&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;course&#39;</span><span class="p">));</span>
<a name="l-21"></a>
<a name="l-22"></a>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$gradeitems</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
<a name="l-23"></a>
<a name="l-24"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$element</span> <span class="o">=</span> <span class="nv">$gtree</span><span class="o">-&gt;</span><span class="na">locate_element</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="o">.</span><span class="nv">$item</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">))</span> <span class="p">{</span>
<a name="l-25"></a>            <span class="nx">\print_error</span><span class="p">(</span><span class="s1">&#39;invalidelementid&#39;</span><span class="p">);</span>
<a name="l-26"></a>        <span class="p">}</span>
<a name="l-27"></a>        <span class="nv">$object</span> <span class="o">=</span> <span class="nv">$element</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">];</span>
<a name="l-28"></a>
<a name="l-29"></a>        <span class="nv">$moveafter</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span><span class="o">.</span><span class="nv">$courseitem</span><span class="o">-&gt;</span><span class="na">iteminstance</span><span class="p">;</span>
<a name="l-30"></a>
<a name="l-31"></a>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$after_el</span> <span class="o">=</span> <span class="nv">$gtree</span><span class="o">-&gt;</span><span class="na">locate_element</span><span class="p">(</span><span class="nv">$moveafter</span><span class="p">))</span> <span class="p">{</span>
<a name="l-32"></a>            <span class="nx">\print_error</span><span class="p">(</span><span class="s1">&#39;invalidelementid&#39;</span><span class="p">);</span>
<a name="l-33"></a>        <span class="p">}</span>
<a name="l-34"></a>
<a name="l-35"></a>        <span class="nv">$after</span> <span class="o">=</span> <span class="nv">$after_el</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">];</span>
<a name="l-36"></a>        <span class="nv">$sortorder</span> <span class="o">=</span> <span class="nv">$after</span><span class="o">-&gt;</span><span class="na">get_sortorder</span><span class="p">();</span>
<a name="l-37"></a>
<a name="l-38"></a>        <span class="nv">$object</span><span class="o">-&gt;</span><span class="na">set_parent</span><span class="p">(</span><span class="nv">$after</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-39"></a>
<a name="l-40"></a>        <span class="nv">$object</span><span class="o">-&gt;</span><span class="na">move_after_sortorder</span><span class="p">(</span><span class="nv">$sortorder</span><span class="p">);</span>
<a name="l-41"></a>
<a name="l-42"></a>    <span class="p">}</span>
<a name="l-43"></a>
<a name="l-44"></a>
<a name="l-45"></a><span class="p">}</span>
</pre></div>

<p><code>sort_gradebook()</code> re-sorts the gradebook for the specified course after the grade items have been added, to place all of the grade items created by this plugin at the far left (and ideally in the correct order).  The complicated bits are achieved using the gradebook APIs included from <code>/grade/lib.php</code> and <code>/grade/edit/tree/lib.php</code>.</p>
<h4><a name="print_tabs">print_tabs()</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">function</span> <span class="nf">print_tabs</span><span class="p">(</span><span class="nv">$selected</span><span class="p">)</span> <span class="p">{</span>
<a name="l-2"></a>    <span class="k">global</span> <span class="nv">$DB</span><span class="p">,</span> <span class="nv">$OUTPUT</span><span class="p">,</span> <span class="nv">$CFG</span><span class="p">;</span>
<a name="l-3"></a>
<a name="l-4"></a>    <span class="nv">$tabs</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="l-5"></a>    <span class="nv">$tabs</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\tabobject</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
<a name="l-6"></a>            <span class="k">new</span> <span class="nx">\moodle_url</span><span class="p">(</span><span class="s1">&#39;/admin/report/targetgrades/alisdata.php&#39;</span><span class="p">),</span>
<a name="l-7"></a>            <span class="nx">\get_string</span><span class="p">(</span><span class="s1">&#39;alisdata&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-8"></a>    <span class="k">if</span><span class="p">(</span><span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_alisdata&#39;</span><span class="p">))</span> <span class="p">{</span>
<a name="l-9"></a>        <span class="nv">$tabs</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\tabobject</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
<a name="l-10"></a>                <span class="k">new</span> <span class="nx">\moodle_url</span><span class="p">(</span><span class="s1">&#39;/admin/report/targetgrades/distribute.php&#39;</span><span class="p">),</span>
<a name="l-11"></a>                <span class="nx">\get_string</span><span class="p">(</span><span class="s1">&#39;mtgdistribute&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-12"></a>    <span class="p">}</span>
<a name="l-13"></a>    <span class="nv">$tabs</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\tabobject</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>
<a name="l-14"></a>            <span class="k">new</span> <span class="nx">\moodle_url</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$CFG</span><span class="o">-&gt;</span><span class="na">admin</span><span class="o">.</span><span class="s1">&#39;/report/targetgrades/settingsform.php&#39;</span><span class="p">),</span>
<a name="l-15"></a>            <span class="nx">\get_string</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">));</span>
<a name="l-16"></a>    <span class="k">echo</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">heading</span><span class="p">(</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;mtgdistribute&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-17"></a>    <span class="nx">\print_tabs</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$tabs</span><span class="p">),</span> <span class="nv">$selected</span><span class="p">);</span>
<a name="l-18"></a><span class="p">}</span>
</pre></div>

<p>Uses Moodle's output APIs to display a heading and 3 tabs for navigating the plugin, one for the ALIS Data page, one for the Distribution/Calculation page, and one for the settings form.  The number passed to the <code>$selected</code> will determine which tab is selected by default.</p>
<h3><a name="classes">Classes</a></h3>
<ul>
<li><a href="#csvhandler">csvhandler</a><br />
</li>
<li><a href="#dcs">distributed_course_selector</a><br />
</li>
<li><a href="#item_grade">item_grade</a><br />
</li>
<li><a href="#pcs">potential_course_selector</a> </li>
</ul>
<h4><a name="item_grade">item_grade</a> et al</h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">abstract</span> <span class="k">class</span> <span class="nc">item_grade</span> <span class="p">{</span>
<a name="l-2"></a>
<a name="l-3"></a>    <span class="k">public</span>   <span class="nv">$courseid</span><span class="p">;</span>
<a name="l-4"></a>    <span class="k">public</span>   <span class="nv">$categoryid</span><span class="p">;</span>
<a name="l-5"></a>    <span class="k">public</span>   <span class="nv">$gradetype</span><span class="p">;</span>
<a name="l-6"></a>    <span class="k">public</span>   <span class="nv">$grademax</span><span class="p">;</span>
<a name="l-7"></a>    <span class="k">public</span>   <span class="nv">$grademin</span><span class="p">;</span>
<a name="l-8"></a>    <span class="k">public</span>   <span class="nv">$hidden</span><span class="p">;</span>
<a name="l-9"></a>    <span class="k">public</span>   <span class="nv">$itemnumber</span><span class="p">;</span>
<a name="l-10"></a>    <span class="k">public</span>   <span class="nv">$itemname</span><span class="p">;</span>
<a name="l-11"></a>    <span class="k">public</span>   <span class="nv">$locked</span><span class="p">;</span>
<a name="l-12"></a>    <span class="k">public</span>   <span class="nv">$idnumber</span><span class="p">;</span>
<a name="l-13"></a>
<a name="l-14"></a>    <span class="sd">/**</span>
<a name="l-15"></a><span class="sd">     * Define common attributes for the subclasses</span>
<a name="l-16"></a><span class="sd">     *</span>
<a name="l-17"></a><span class="sd">     * @param int $courseid The course the grade item belongs to</span>
<a name="l-18"></a><span class="sd">     * @param int $categoryid The category the grade item belongs to</span>
<a name="l-19"></a><span class="sd">     */</span>
<a name="l-20"></a>    <span class="k">protected</span> <span class="k">function</span>  <span class="nf">__construct</span><span class="p">(</span><span class="nv">$courseid</span><span class="p">,</span> <span class="nv">$categoryid</span><span class="p">)</span> <span class="p">{</span>
<a name="l-21"></a>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">courseid</span> <span class="o">=</span> <span class="nv">$courseid</span><span class="p">;</span>
<a name="l-22"></a>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">categoryid</span> <span class="o">=</span> <span class="nv">$categoryid</span><span class="p">;</span>
<a name="l-23"></a>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hidden</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="l-24"></a>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">grademin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="l-25"></a>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">idnumber</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<a name="l-26"></a>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">timecreated</span> <span class="o">=</span> <span class="nx">\time</span><span class="p">();</span>
<a name="l-27"></a>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">timemodified</span> <span class="o">=</span> <span class="nx">\time</span><span class="p">();</span>
<a name="l-28"></a>    <span class="p">}</span>
<a name="l-29"></a><span class="p">}</span>
</pre></div>

<p>This is a base class extended by several others to create templates for the various grade items used in the plugin.  The names, types and scales are set automatically. The object created by these classes can be passed to <code>grade_item::set_properties()</code> to define or update the grade item.</p>
<h4><a name="csvhandler">csvhandler</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">class</span> <span class="nc">csvhandler</span> <span class="p">{</span>
</pre></div>

<div class="highlight"><pre><a name="l-1"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$filename</span><span class="p">)</span> <span class="p">{</span>
<a name="l-2"></a>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">filename</span> <span class="o">=</span> <span class="nv">$filename</span><span class="p">;</span>
<a name="l-3"></a>    <span class="p">}</span>
</pre></div>

<p><code>csvhandler</code> is used to validate and process a CSV file uploaded to <code>alisdata.php</code>.  To construct the object, you simple pass it the filename.</p>
<div class="highlight"><pre><a name="l-1"></a>    <span class="k">private</span> <span class="k">function</span> <span class="nf">open_file</span><span class="p">()</span> <span class="p">{</span>
<a name="l-2"></a>        <span class="k">global</span> <span class="nv">$USER</span><span class="p">;</span>
<a name="l-3"></a>
<a name="l-4"></a>        <span class="nv">$fs</span> <span class="o">=</span> <span class="nx">\get_file_storage</span><span class="p">();</span>
<a name="l-5"></a>        <span class="nv">$context</span> <span class="o">=</span> <span class="nx">\get_context_instance</span><span class="p">(</span><span class="nx">CONTEXT_USER</span><span class="p">,</span> <span class="nv">$USER</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-6"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$files</span> <span class="o">=</span> <span class="nv">$fs</span><span class="o">-&gt;</span><span class="na">get_area_files</span><span class="p">(</span><span class="nv">$context</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;draft&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">filename</span><span class="p">,</span> <span class="s1">&#39;id DESC&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">))</span> <span class="p">{</span>
<a name="l-7"></a>            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\moodle_exception</span><span class="p">(</span><span class="s1">&#39;cantreadcsv&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-8"></a>        <span class="p">}</span>
<a name="l-9"></a>        <span class="nv">$file</span> <span class="o">=</span> <span class="nx">\reset</span><span class="p">(</span><span class="nv">$files</span><span class="p">);</span>
<a name="l-10"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$file</span> <span class="o">=</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">get_content_file_handle</span><span class="p">())</span> <span class="p">{</span>
<a name="l-11"></a>            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\moodle_exception</span><span class="p">(</span><span class="s1">&#39;cantreadcsv&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-12"></a>        <span class="p">}</span>
<a name="l-13"></a>
<a name="l-14"></a>        <span class="k">return</span> <span class="nv">$file</span><span class="p">;</span>
<a name="l-15"></a>    <span class="p">}</span>
</pre></div>

<p>The <code>open_file()</code> method uses Moodle's File API to find the file with the given file name, open it, and return a file handle used to access the file's contents.</p>
<div class="highlight"><pre><a name="l-1"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">validate</span><span class="p">()</span> <span class="p">{</span>
<a name="l-2"></a>        <span class="nv">$line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="l-3"></a>        <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">open_file</span><span class="p">();</span>
<a name="l-4"></a>        <span class="k">while</span> <span class="p">(</span><span class="nv">$csvrow</span> <span class="o">=</span> <span class="nx">\fgetcsv</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">))</span> <span class="p">{</span>
<a name="l-5"></a>            <span class="nv">$line</span><span class="o">++</span><span class="p">;</span>
<a name="l-6"></a>            <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$csvrow</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$csvrow</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
<a name="l-7"></a>                <span class="k">throw</span> <span class="k">new</span> <span class="nx">\moodle_exception</span><span class="p">(</span><span class="s1">&#39;wrongcolcsv&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$line</span><span class="p">);</span>
<a name="l-8"></a>            <span class="p">}</span>
<a name="l-9"></a>        <span class="p">}</span>
<a name="l-10"></a>        <span class="nx">\fclose</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
<a name="l-11"></a>        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<a name="l-12"></a>    <span class="p">}</span>
</pre></div>

<p>The <code>validate()</code> method makes sure that the CSV file is in the correct format. Files produced using the provided script should have either 1 or 6 fields on every row.  If the uploaded file doesn't look like this, an exception is thrown.</p>
<div class="highlight"><pre><a name="l-1"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">process</span><span class="p">()</span> <span class="p">{</span>
<a name="l-2"></a>        <span class="k">global</span> <span class="nv">$DB</span><span class="p">;</span>
<a name="l-3"></a>
<a name="l-4"></a>        <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">open_file</span><span class="p">();</span>
<a name="l-5"></a>        <span class="nv">$qualtype</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<a name="l-6"></a>        <span class="nv">$import</span><span class="o">-&gt;</span><span class="na">qualcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="l-7"></a>        <span class="nv">$import</span><span class="o">-&gt;</span><span class="na">subjectcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="l-8"></a>        <span class="nv">$import</span><span class="o">-&gt;</span><span class="na">updatecount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="l-9"></a>        <span class="k">while</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=</span> <span class="nx">\fgetcsv</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">))</span> <span class="p">{</span>
</pre></div>

<p>The <code>process()</code> method parses all the data in the file and inserts it into the database, then performs some quality checks on the data.  It starts by looping over each line, splitting the fields up into an array called <code>$line</code>.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="c1">// If there&#39;s only one column on this line, then it&#39;s a qualification heading</span>
<a name="l-2"></a>            <span class="k">if</span> <span class="p">(</span><span class="nx">\count</span><span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="l-3"></a>                <span class="nv">$qualname</span> <span class="o">=</span> <span class="nx">\clean_param</span><span class="p">(</span><span class="nv">$line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">\PARAM_TEXT</span><span class="p">);</span>
<a name="l-4"></a>                <span class="c1">// Create a new qualtype record if there isn&#39;t one already.</span>
<a name="l-5"></a>                <span class="nv">$where</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">sql_compare_text</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39; = ?&#39;</span><span class="p">;</span>
<a name="l-6"></a>                <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$qualname</span><span class="p">);</span>
<a name="l-7"></a>                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$qualtype</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record_select</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_qualtype&#39;</span><span class="p">,</span> <span class="nv">$where</span><span class="p">,</span> <span class="nv">$params</span><span class="p">))</span> <span class="p">{</span>
<a name="l-8"></a>                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$qualscale</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$qualname</span><span class="o">.</span><span class="s1">&#39; MTG&#39;</span><span class="p">)))</span> <span class="p">{</span>
<a name="l-9"></a>
<a name="l-10"></a>                        <span class="k">if</span><span class="p">(</span><span class="nv">$scale</span> <span class="o">=</span> <span class="nx">get_scale</span><span class="p">(</span><span class="nv">$qualname</span><span class="p">))</span> <span class="p">{</span>
<a name="l-11"></a>                            <span class="nv">$qualscale</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\stdClass</span><span class="p">;</span>
<a name="l-12"></a>                            <span class="nv">$qualscale</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$qualname</span><span class="o">.</span><span class="s1">&#39; MTG&#39;</span><span class="p">;</span>
<a name="l-13"></a>                            <span class="nv">$qualscale</span><span class="o">-&gt;</span><span class="na">scale</span> <span class="o">=</span> <span class="nv">$scale</span><span class="p">;</span>
<a name="l-14"></a>                            <span class="nv">$qualscale</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="nv">$qualname</span><span class="o">.</span><span class="s1">&#39; Minimum/Target Grades&#39;</span><span class="p">;</span>
<a name="l-15"></a>                            <span class="nv">$qualscale</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">insert_record</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="nv">$qualscale</span><span class="p">);</span>
<a name="l-16"></a>                        <span class="p">}</span>
<a name="l-17"></a>
<a name="l-18"></a>                    <span class="p">}</span>
<a name="l-19"></a>
<a name="l-20"></a>                    <span class="k">if</span><span class="p">(</span><span class="nv">$qualscale</span><span class="p">)</span> <span class="p">{</span>
<a name="l-21"></a>                        <span class="nv">$qualtype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\stdClass</span><span class="p">;</span>
<a name="l-22"></a>                        <span class="nv">$qualtype</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$qualname</span><span class="p">;</span>
<a name="l-23"></a>                        <span class="nv">$qualtype</span><span class="o">-&gt;</span><span class="na">scaleid</span> <span class="o">=</span> <span class="nv">$qualscale</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
<a name="l-24"></a>                        <span class="nv">$qualtype</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">insert_record</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_qualtype&#39;</span><span class="p">,</span> <span class="nv">$qualtype</span><span class="p">);</span>
<a name="l-25"></a>                        <span class="nv">$import</span><span class="o">-&gt;</span><span class="na">qualcount</span><span class="o">++</span><span class="p">;</span>
<a name="l-26"></a>                    <span class="p">}</span>
<a name="l-27"></a>                <span class="p">}</span>
</pre></div>

<p>Lines only containing a single field will be a heading for a qualification.  If that's the case the value is cleaned, then the record for the qualification is created or updated, and matched with the grade scale.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-2"></a>                <span class="c1">// If we have a record for this course&#39;s qualtype</span>
<a name="l-3"></a>                <span class="k">if</span> <span class="p">(</span><span class="nv">$qualtype</span><span class="p">)</span> <span class="p">{</span>
<a name="l-4"></a>                    <span class="nv">$name</span> <span class="o">=</span> <span class="nx">\clean_param</span><span class="p">(</span><span class="nv">$line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">\PARAM_TEXT</span><span class="p">);</span>
<a name="l-5"></a>                    <span class="nv">$samplesize</span> <span class="o">=</span> <span class="nx">\clean_param</span><span class="p">(</span><span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$line</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nx">\PARAM_INT</span><span class="p">);</span>
<a name="l-6"></a>                    <span class="nv">$gradient</span> <span class="o">=</span> <span class="nx">\clean_param</span><span class="p">(</span><span class="nv">$line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">\PARAM_FLOAT</span><span class="p">);</span>
<a name="l-7"></a>                    <span class="nv">$intercept</span> <span class="o">=</span> <span class="nx">\clean_param</span><span class="p">(</span><span class="nv">$line</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">\PARAM_FLOAT</span><span class="p">);</span>
<a name="l-8"></a>                    <span class="nv">$correlation</span> <span class="o">=</span> <span class="nx">\clean_param</span><span class="p">(</span><span class="nv">$line</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">\PARAM_FLOAT</span><span class="p">);</span>
<a name="l-9"></a>                    <span class="nv">$standarddeviation</span> <span class="o">=</span> <span class="nx">\clean_param</span><span class="p">(</span><span class="nv">$line</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="nx">\PARAM_FLOAT</span><span class="p">);</span>
<a name="l-10"></a>                    <span class="nv">$where</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">sql_compare_text</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39; = ? AND qualtypeid = ?&#39;</span><span class="p">;</span>
<a name="l-11"></a>                    <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$qualtype</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a name="l-12"></a>                    <span class="k">if</span><span class="p">(</span><span class="nv">$subject</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record_select</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_alisdata&#39;</span><span class="p">,</span> <span class="nv">$where</span><span class="p">,</span> <span class="nv">$params</span><span class="p">))</span> <span class="p">{</span>
<a name="l-13"></a>                        <span class="nv">$subject</span><span class="o">-&gt;</span><span class="na">samplesize</span> <span class="o">=</span> <span class="nv">$samplesize</span><span class="p">;</span>
<a name="l-14"></a>                        <span class="nv">$subject</span><span class="o">-&gt;</span><span class="na">gradient</span> <span class="o">=</span> <span class="nv">$gradient</span><span class="p">;</span>
<a name="l-15"></a>                        <span class="nv">$subject</span><span class="o">-&gt;</span><span class="na">intercept</span> <span class="o">=</span> <span class="nv">$intercept</span><span class="p">;</span>
<a name="l-16"></a>                        <span class="nv">$subject</span><span class="o">-&gt;</span><span class="na">correlation</span> <span class="o">=</span> <span class="nv">$correlation</span><span class="p">;</span>
<a name="l-17"></a>                        <span class="nv">$subject</span><span class="o">-&gt;</span><span class="na">standarddeviation</span> <span class="o">=</span> <span class="nv">$standarddeviation</span><span class="p">;</span>
<a name="l-18"></a>                        <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">update_record</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_alisdata&#39;</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">);</span>
<a name="l-19"></a>                        <span class="nv">$import</span><span class="o">-&gt;</span><span class="na">updatecount</span><span class="o">++</span><span class="p">;</span>
<a name="l-20"></a>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-21"></a>                        <span class="nv">$subject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\stdClass</span><span class="p">;</span>
<a name="l-22"></a>                        <span class="nv">$subject</span><span class="o">-&gt;</span><span class="na">name</span><span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
<a name="l-23"></a>                        <span class="nv">$subject</span><span class="o">-&gt;</span><span class="na">samplesize</span> <span class="o">=</span> <span class="nv">$samplesize</span><span class="p">;</span>
<a name="l-24"></a>                        <span class="nv">$subject</span><span class="o">-&gt;</span><span class="na">gradient</span> <span class="o">=</span> <span class="nv">$gradient</span><span class="p">;</span>
<a name="l-25"></a>                        <span class="nv">$subject</span><span class="o">-&gt;</span><span class="na">intercept</span> <span class="o">=</span> <span class="nv">$intercept</span><span class="p">;</span>
<a name="l-26"></a>                        <span class="nv">$subject</span><span class="o">-&gt;</span><span class="na">correlation</span> <span class="o">=</span> <span class="nv">$correlation</span><span class="p">;</span>
<a name="l-27"></a>                        <span class="nv">$subject</span><span class="o">-&gt;</span><span class="na">standarddeviation</span> <span class="o">=</span> <span class="nv">$standarddeviation</span><span class="p">;</span>
<a name="l-28"></a>                        <span class="nv">$subject</span><span class="o">-&gt;</span><span class="na">qualtypeid</span> <span class="o">=</span> <span class="nv">$qualtype</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
<a name="l-29"></a>                        <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">insert_record</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_alisdata&#39;</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">);</span>
<a name="l-30"></a>                        <span class="nv">$import</span><span class="o">-&gt;</span><span class="na">subjectcount</span><span class="o">++</span><span class="p">;</span>
<a name="l-31"></a>                    <span class="p">}</span>
<a name="l-32"></a>                <span class="p">}</span>
<a name="l-33"></a>            <span class="p">}</span>
<a name="l-34"></a>        <span class="p">}</span>
<a name="l-35"></a>
<a name="l-36"></a>        <span class="nx">\fclose</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
<a name="l-37"></a>
<a name="l-38"></a>        <span class="c1">// All the stats are now in the DB, so do a pass over the table to flag up any quality issues with the data</span>
</pre></div>

<p>Lines containing 6 fields will be a qualification with a set of statistics.  In this case we clean the values in each field and either insert or update a record for the qualification.
When we've done all the lines, we close the file.</p>
<div class="highlight"><pre><a name="l-1"></a>        <span class="nv">$averagesize</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record_sql</span><span class="p">(</span><span class="s1">&#39;SELECT AVG(samplesize) as avg FROM {report_targetgrades_alisdata}&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">avg</span><span class="p">);</span>
<a name="l-2"></a>        <span class="nv">$select</span> <span class="o">=</span> <span class="s1">&#39;SELECT ta.*, tq.name as qualification &#39;</span><span class="p">;</span>
<a name="l-3"></a>        <span class="nv">$from</span> <span class="o">=</span> <span class="s1">&#39;FROM {report_targetgrades_alisdata} ta</span>
<a name="l-4"></a><span class="s1">            JOIN {report_targetgrades_qualtype} tq ON ta.qualtypeid = tq.id&#39;</span><span class="p">;</span>
<a name="l-5"></a>        <span class="nv">$alisdata</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_sql</span><span class="p">(</span><span class="nv">$select</span><span class="o">.</span><span class="nv">$from</span><span class="p">);</span>
<a name="l-6"></a>
<a name="l-7"></a>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$alisdata</span> <span class="k">as</span> <span class="nv">$alis</span><span class="p">)</span> <span class="p">{</span>
</pre></div>

<p>Once the file's been processed and the records are in the database, we do some quality checks to flag up any potential issues with the sample size, correlation, or standard deviation of the data.  This starts by getting all the records in the <code>alisdata</code> table, along with the average sample size for comparison.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="k">if</span> <span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">samplesize</span> <span class="o">&lt;</span> <span class="nv">$averagesize</span><span class="p">)</span> <span class="p">{</span>
<a name="l-2"></a>                <span class="k">if</span> <span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">samplesize</span> <span class="o">&lt;</span> <span class="nv">$averagesize</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<a name="l-3"></a>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">samplesize</span> <span class="o">&lt;</span> <span class="nv">$averagesize</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
<a name="l-4"></a>                        <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_samplesize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<a name="l-5"></a>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-6"></a>                        <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_samplesize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="l-7"></a>                    <span class="p">}</span>
<a name="l-8"></a>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-9"></a>                    <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_samplesize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="l-10"></a>                <span class="p">}</span>
<a name="l-11"></a>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-12"></a>                <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_samplesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="l-13"></a>            <span class="p">}</span>
</pre></div>

<p>Using the average size as a benchmark, the we check if the sample size for the current record is below average, below half of the average, or below a quarter of the average, and add a flag to the record accordingly.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="k">if</span> <span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">correlation</span> <span class="o">&lt;</span> <span class="nx">CORRELATION_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
<a name="l-2"></a>                <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_correlation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="l-3"></a>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-4"></a>                <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_correlation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="l-5"></a>            <span class="p">}</span>
</pre></div>

<p>Next we take a look at the correlation. If it's below the defined <a href="#constants">correlation</a> threshold we add a flag to the record.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="k">switch</span> <span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">qualification</span><span class="p">)</span> <span class="p">{</span>
<a name="l-2"></a>                <span class="k">case</span> <span class="nx">ALIS_GCSE</span><span class="o">:</span>
<a name="l-3"></a>                <span class="k">case</span> <span class="nx">ALIS_BTEC_FIRST_DIPLOMA</span><span class="o">:</span>
<a name="l-4"></a>                <span class="k">case</span> <span class="nx">ALIS_IB_STANDARD</span><span class="o">:</span>
<a name="l-5"></a>                <span class="k">case</span> <span class="nx">ALIS_IB_HIGHER</span><span class="o">:</span>
<a name="l-6"></a>                <span class="k">case</span> <span class="nx">ALIS_OCR_NATIONAL_CERTIFICATE</span><span class="o">:</span>
<a name="l-7"></a>                <span class="k">case</span> <span class="nx">ALIS_OCR_NATIONAL_DIPLOMA</span><span class="o">:</span>
<a name="l-8"></a>                    <span class="nv">$boundary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="l-9"></a>                    <span class="k">break</span><span class="p">;</span>
<a name="l-10"></a>
<a name="l-11"></a>                <span class="k">case</span> <span class="nx">ALIS_ADVANCED_GCE</span><span class="o">:</span>
<a name="l-12"></a>                <span class="k">case</span> <span class="nx">ALIS_ADVANCED_GCE_DOUBLE</span><span class="o">:</span>
<a name="l-13"></a>                    <span class="nv">$boundary</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<a name="l-14"></a>                    <span class="k">break</span><span class="p">;</span>
<a name="l-15"></a>
<a name="l-16"></a>                <span class="k">case</span> <span class="nx">ALIS_ADVANCED_SUBSIDIARY_GCE</span><span class="o">:</span>
<a name="l-17"></a>                <span class="k">case</span> <span class="nx">ALIS_ADVANCED_SUBSIDIARY_GCE_DOUBLE</span><span class="o">:</span>
<a name="l-18"></a>                    <span class="nv">$boundary</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<a name="l-19"></a>                    <span class="k">break</span><span class="p">;</span>
<a name="l-20"></a>
<a name="l-21"></a>                <span class="k">case</span> <span class="nx">ALIS_BTEC_NATIONAL_AWARD</span><span class="o">:</span>
<a name="l-22"></a>                <span class="k">case</span> <span class="nx">ALIS_BTEC_NATIONAL_DIPLOMA</span><span class="o">:</span>
<a name="l-23"></a>                <span class="k">case</span> <span class="nx">ALIS_BTEC_NATIONAL_CERTIFICATE</span><span class="o">:</span>
<a name="l-24"></a>                    <span class="nv">$boundary</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
<a name="l-25"></a>                    <span class="k">break</span><span class="p">;</span>
<a name="l-26"></a>
<a name="l-27"></a>                <span class="k">case</span> <span class="nx">ALIS_CACHE_L3_DIPLOMA</span><span class="o">:</span>
<a name="l-28"></a>                    <span class="nv">$boundary</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
<a name="l-29"></a>                    <span class="k">break</span><span class="p">;</span>
<a name="l-30"></a>            <span class="p">}</span>
<a name="l-31"></a>
<a name="l-32"></a>            <span class="k">if</span> <span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">standarddeviation</span> <span class="o">&gt;</span> <span class="nv">$boundary</span><span class="p">)</span> <span class="p">{</span>
<a name="l-33"></a>                <span class="k">if</span> <span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">standarddeviation</span> <span class="o">&gt;</span> <span class="nv">$boundary</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<a name="l-34"></a>                    <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_deviation</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="l-35"></a>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-36"></a>                    <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_deviation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="l-37"></a>                <span class="p">}</span>
<a name="l-38"></a>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-39"></a>                <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_deviation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="l-40"></a>            <span class="p">}</span>
</pre></div>

<p>Finally we take a look at the standard deviation.  This is likely to cause problems if it's greater than 1 grade boundary, so we need to work out which grade bounary we're working with by looking at the qualification type.  We then see if the deviation is greater than 1 or 2 boundaries, and add a flag accordingly.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">update_record</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_alisdata&#39;</span><span class="p">,</span> <span class="nv">$alis</span><span class="p">);</span>
<a name="l-2"></a>        <span class="p">}</span>
<a name="l-3"></a>
<a name="l-4"></a>        <span class="k">return</span> <span class="nv">$import</span><span class="p">;</span>
<a name="l-5"></a>    <span class="p">}</span>
</pre></div>

<p>Once we've done all the quality checks we update the records in the database, and we're done.</p>
<h4><a name="pcs">potential_course_selector</a></h4>
<div class="highlight"><pre><a name="l-1"></a>    <span class="k">class</span> <span class="nc">potential_course_selector</span> <span class="k">extends</span> <span class="nx">\user_selector_base</span> <span class="p">{</span>
</pre></div>

<p>The Potential Course Selector displays the right hand side of the Big Select List in <code>distribute.php</code>.  It's an extension of <code>user_selector</code> from <code>/user/selector/lib.php</code> and won't be defined unless this file has already been included.  This is also true of the <a href="#dcs">distributed_course_selector</a>.</p>
<div class="highlight"><pre><a name="l-1"></a>        <span class="k">protected</span> <span class="k">function</span> <span class="nf">get_options</span><span class="p">()</span> <span class="p">{</span>
<a name="l-2"></a>            <span class="nv">$options</span> <span class="o">=</span> <span class="k">parent</span><span class="o">::</span><span class="na">get_options</span><span class="p">();</span>
<a name="l-3"></a>            <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;admin/report/targetgrades/lib.php&#39;</span><span class="p">;</span>
<a name="l-4"></a>            <span class="k">return</span> <span class="nv">$options</span><span class="p">;</span>
<a name="l-5"></a>        <span class="p">}</span>
</pre></div>

<p>The <code>get_options()</code> method simply overrides the parent method to add the path of the lib.php file, allowing it to be included when using AJAX to search the list.</p>
<div class="highlight"><pre><a name="l-1"></a>        <span class="k">public</span> <span class="k">function</span> <span class="nf">find_users</span><span class="p">(</span><span class="nv">$search</span><span class="p">)</span> <span class="p">{</span>
<a name="l-2"></a>            <span class="k">global</span> <span class="nv">$DB</span><span class="p">;</span>
<a name="l-3"></a>            <span class="nv">$config</span> <span class="o">=</span> <span class="nx">get_config</span><span class="p">();</span>
</pre></div>

<p><code>find_users()</code> gets the list of users to display.  As this class is an extension of <code>user_selector</code>, it uses funny names for the fields (and the method) to save having to override all the other methods, so the course's shortname is called surname, and the fullname is called email, while firstname is used to hold an indicator from <code>&lt;a href='#hasconfig'&gt;hasconfig&lt;/a&gt;</code> if required.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="k">list</span><span class="p">(</span><span class="nv">$in_sql</span><span class="p">,</span> <span class="nv">$params</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_in_or_equal</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">categories</span><span class="p">);</span>
</pre></div>

<p>We start by converting the configured course categories to an IN statement.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="nv">$select</span> <span class="o">=</span> <span class="s1">&#39;SELECT c.id, c.shortname AS lastname, &quot;&quot; AS firstname, c.fullname AS email, q.name AS qualtype, &#39;</span><span class="p">;</span>
<a name="l-2"></a>            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_field</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_length</span><span class="p">))</span> <span class="p">{</span>
<a name="l-3"></a>                <span class="nv">$args</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_field</span><span class="p">,</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_length</span><span class="p">);</span>
<a name="l-4"></a>                <span class="nv">$select</span> <span class="o">.=</span> <span class="nx">\vsprintf</span><span class="p">(</span><span class="s1">&#39;LEFT(c.%1$s, %2$d) AS pattern &#39;</span><span class="p">,</span> <span class="nv">$args</span><span class="p">);</span>
<a name="l-5"></a>                <span class="nv">$from</span> <span class="o">=</span> <span class="nx">\vsprintf</span><span class="p">(</span><span class="s1">&#39;FROM {course} c</span>
<a name="l-6"></a><span class="s1">                            LEFT JOIN {report_targetgrades_patterns} p</span>
<a name="l-7"></a><span class="s1">                                ON LEFT(c.%1$s, %2$d) = CAST(p.pattern AS CHAR)</span>
<a name="l-8"></a><span class="s1">                            LEFT JOIN {report_targetgrades_alisdata} d ON p.alisdataid = d.id</span>
<a name="l-9"></a><span class="s1">                            LEFT JOIN {report_targetgrades_qualtype} q ON d.qualtypeid = q.id &#39;</span><span class="p">,</span> <span class="nv">$args</span><span class="p">);</span>
<a name="l-10"></a>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-11"></a>                <span class="nv">$select</span> <span class="o">.=</span> <span class="s1">&#39;shortname AS pattern &#39;</span><span class="p">;</span>
<a name="l-12"></a>                <span class="nv">$from</span> <span class="o">=</span> <span class="s1">&#39;FROM {course} c</span>
<a name="l-13"></a><span class="s1">                            LEFT JOIN {report_targetgrades_patterns} p ON c.shortname = p.pattern</span>
<a name="l-14"></a><span class="s1">                            LEFT JOIN {report_targetgrades_alisdata} d ON p.alisdataid = d.id</span>
<a name="l-15"></a><span class="s1">                            LEFT JOIN {report_targetgrades_qualtype} q ON d.qualtypeid = q.id &#39;</span><span class="p">;</span>
<a name="l-16"></a>            <span class="p">}</span>
<a name="l-17"></a>
<a name="l-18"></a>            <span class="nv">$order</span> <span class="o">=</span> <span class="s1">&#39;ORDER BY pattern&#39;</span><span class="p">;</span>
</pre></div>

<p>Next we get all the fields.  If a <code>group_field</code> and <code>group_length</code> are set, then it will also get a pattern based in these settings.  Otherwise, it will just use the whole shortname.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="k">if</span> <span class="p">(</span><span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">sql_regex_supported</span><span class="p">())</span> <span class="p">{</span>
<a name="l-2"></a>                <span class="nv">$where</span> <span class="o">=</span> <span class="s1">&#39;WHERE category &#39;</span><span class="o">.</span><span class="nv">$in_sql</span><span class="o">.</span><span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">exclude_field</span><span class="o">.</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">sql_regex</span><span class="p">(</span><span class="k">false</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39; ? &#39;</span><span class="p">;</span>
<a name="l-3"></a>                <span class="nv">$params</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$params</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">exclude_regex</span><span class="p">));</span>
<a name="l-4"></a>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-5"></a>                <span class="nv">$courses</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_select</span><span class="p">(</span><span class="s1">&#39;course&#39;</span><span class="p">,</span> <span class="s1">&#39;category &#39;</span><span class="o">.</span><span class="nv">$in_sql</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>
<a name="l-6"></a>
<a name="l-7"></a>                <span class="nx">\array_filter</span><span class="p">(</span><span class="nv">$courses</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$course</span><span class="p">,</span> <span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>
<a name="l-8"></a>                    <span class="nv">$field</span> <span class="o">=</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">exclude_field</span><span class="p">;</span>
<a name="l-9"></a>                    <span class="k">return</span> <span class="o">!</span><span class="nx">\preg_match</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">exclude_regex</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$course</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">);</span>
<a name="l-10"></a>                <span class="p">});</span>
<a name="l-11"></a>
<a name="l-12"></a>                <span class="k">list</span><span class="p">(</span><span class="nv">$in_sql</span><span class="p">,</span> <span class="nv">$params</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_in_or_equal</span><span class="p">(</span><span class="nb">array_keys</span><span class="p">(</span><span class="nv">$courses</span><span class="p">));</span>
<a name="l-13"></a>                <span class="nv">$where</span> <span class="o">=</span> <span class="s1">&#39;WHERE id &#39;</span><span class="o">.</span><span class="nv">$in_sql</span><span class="o">.</span><span class="s1">&#39; &#39;</span><span class="p">;</span>
<a name="l-14"></a>            <span class="p">}</span>
</pre></div>

<p>If an <code>exclude_field</code> and <code>exclude_regex</code> are defined, the courses that match it are filtered out.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="nv">$optgroupname</span> <span class="o">=</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;courseswithoutgrades&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-2"></a>
<a name="l-3"></a>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$search</span><span class="p">))</span> <span class="p">{</span>
<a name="l-4"></a>                <span class="nv">$shortnamelike</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">sql_like</span><span class="p">(</span><span class="s1">&#39;shortname&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">);</span>
<a name="l-5"></a>                <span class="nv">$fullnamelike</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">sql_like</span><span class="p">(</span><span class="s1">&#39;fullname&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">);</span>
<a name="l-6"></a>                <span class="nv">$where</span> <span class="o">.=</span> <span class="s1">&#39;AND (&#39;</span><span class="o">.</span><span class="nv">$shortnamelike</span><span class="o">.</span><span class="s1">&#39; OR &#39;</span><span class="o">.</span><span class="nv">$fullnamelike</span><span class="o">.</span><span class="s1">&#39;) &#39;</span><span class="p">;</span>
<a name="l-7"></a>                <span class="nv">$params</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$params</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="o">.</span><span class="nv">$search</span><span class="o">.</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="o">.</span><span class="nv">$search</span><span class="o">.</span><span class="s1">&#39;%&#39;</span><span class="p">));</span>
<a name="l-8"></a>                <span class="nv">$optgroupname</span> <span class="o">.=</span> <span class="s1">&#39; - &#39;</span><span class="o">.</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;searchresults&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-9"></a>            <span class="p">}</span>
</pre></div>

<p>If any search text was provided using the <code>$search</code> parameter, then results are filtered to those where <code>$search</code> appears in <code>shortname</code> or <code>fullname</code>.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exclude</span><span class="p">))</span> <span class="p">{</span>
<a name="l-2"></a>                <span class="k">list</span><span class="p">(</span><span class="nv">$not_in_sql</span><span class="p">,</span> <span class="nv">$not_in_params</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_in_or_equal</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exclude</span><span class="p">,</span> <span class="nx">SQL_PARAMS_QM</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
<a name="l-3"></a>                <span class="nv">$where</span> <span class="o">.=</span> <span class="s1">&#39;AND c.id &#39;</span><span class="o">.</span><span class="nv">$not_in_sql</span><span class="o">.</span><span class="s1">&#39; &#39;</span><span class="p">;</span>
<a name="l-4"></a>                <span class="nv">$params</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$params</span><span class="p">,</span> <span class="nv">$not_in_params</span><span class="p">);</span>
<a name="l-5"></a>            <span class="p">}</span>
</pre></div>

<p>If the object has any IDs set for exlusion, they are also filtered out.  This is used to ensure that no courses in the <code>[distributed_course_selector](#dcs)</code> appear in the list.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="nv">$options</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_sql</span><span class="p">(</span><span class="nv">$select</span><span class="o">.</span><span class="nv">$from</span><span class="o">.</span><span class="nv">$where</span><span class="o">.</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>
<a name="l-2"></a>
<a name="l-3"></a>            <span class="nv">$options</span> <span class="o">=</span> <span class="nx">hasconfig</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
<a name="l-4"></a>
<a name="l-5"></a>            <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$optgroupname</span> <span class="o">=&gt;</span> <span class="nv">$options</span><span class="p">);</span>
<a name="l-6"></a>        <span class="p">}</span>
</pre></div>

<p>And we're done. Run the query, and return the results in a 2D array with the optgroup heading as the index. </p>
<h4><a name="dcs">distributed_course_selector</a></h4>
<div class="highlight"><pre><a name="l-1"></a>    <span class="k">class</span> <span class="nc">distributed_course_selector</span> <span class="k">extends</span> <span class="nx">potential_course_selector</span> <span class="p">{</span>
</pre></div>

<p>The Distributed Course Selector displays the left hand side of the Big Select List in <code>distubute.php</code>.  It extends <code>potential_course_selector</code> to save duplication of the <code>get_options()</code> method, and displays those courses which already contain the Target Grade items.</p>
<div class="highlight"><pre><a name="l-1"></a>        <span class="k">function</span> <span class="nf">find_users</span><span class="p">(</span><span class="nv">$search</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
<a name="l-2"></a>            <span class="k">global</span> <span class="nv">$DB</span><span class="p">;</span>
<a name="l-3"></a>            <span class="nv">$config</span> <span class="o">=</span> <span class="nx">get_config</span><span class="p">();</span>
</pre></div>

<p><code>find_users()</code> starts by getting the plugin's config.  It's worth noting that while the method accepts an arugment, this argument it not used - it's only there to satisfy the requirements of overriding the abstract ancestor method.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="nv">$select</span> <span class="o">=</span> <span class="s1">&#39;SELECT DISTINCT c.id, c.shortname AS lastname,</span>
<a name="l-2"></a><span class="s1">                        &quot;&quot; AS firstname, c.fullname AS email, q.name AS qualtype, &#39;</span><span class="p">;</span>
<a name="l-3"></a>
<a name="l-4"></a>            <span class="nv">$from</span> <span class="o">=</span> <span class="s1">&#39;FROM {course} c</span>
<a name="l-5"></a><span class="s1">                        JOIN {grade_items} g ON c.id = g.courseid &#39;</span><span class="p">;</span>
</pre></div>

<p>As with <code>potential_course_selector</code>, we use field names as though the course records were use records.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_field</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_length</span><span class="p">))</span> <span class="p">{</span>
<a name="l-2"></a>                <span class="nv">$args</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_field</span><span class="p">,</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">group_length</span><span class="p">);</span>
<a name="l-3"></a>                <span class="nv">$select</span> <span class="o">.=</span> <span class="nx">\vsprintf</span><span class="p">(</span><span class="s1">&#39;LEFT(c.%1$s, %2$d) AS pattern &#39;</span><span class="p">,</span> <span class="nv">$args</span><span class="p">);</span>
<a name="l-4"></a>                <span class="nv">$from</span> <span class="o">.=</span> <span class="nx">\vsprintf</span><span class="p">(</span><span class="s1">&#39;LEFT JOIN {report_targetgrades_patterns} p</span>
<a name="l-5"></a><span class="s1">                                        ON LEFT(c.%1$s, %2$d) = CAST(p.pattern AS CHAR)</span>
<a name="l-6"></a><span class="s1">                                    LEFT JOIN {report_targetgrades_alisdata} d ON p.alisdataid = d.id</span>
<a name="l-7"></a><span class="s1">                                    LEFT JOIN {report_targetgrades_qualtype} q ON d.qualtypeid = q.id &#39;</span><span class="p">,</span> <span class="nv">$args</span><span class="p">);</span>
<a name="l-8"></a>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-9"></a>                <span class="nv">$select</span> <span class="o">.=</span> <span class="s1">&#39;shortname AS pattern &#39;</span><span class="p">;</span>
<a name="l-10"></a>                <span class="nv">$from</span> <span class="o">.=</span> <span class="s1">&#39;LEFT JOIN {report_targetgrades_patterns} p ON c.shortname = p.pattern</span>
<a name="l-11"></a><span class="s1">                            LEFT JOIN {report_targetgrades_alisdata} d ON p.alisdataid = d.id</span>
<a name="l-12"></a><span class="s1">                            LEFT JOIN {report_targetgrades_qualtype} q ON d.qualtypeid = q.id &#39;</span><span class="p">;</span>
<a name="l-13"></a>            <span class="p">}</span>
</pre></div>

<p>If a <code>group_field</code> and <code>group_length</code> are set, we use them to create a pattern, otherwise we just use the shortname.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="nv">$itemnames</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;item_avgcse&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-2"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;item_alisnum&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-3"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;item_alis&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-4"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;item_mtg&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-5"></a>            <span class="k">list</span><span class="p">(</span><span class="nv">$in_sql</span><span class="p">,</span> <span class="nv">$in_params</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_in_or_equal</span><span class="p">(</span><span class="nv">$itemnames</span><span class="p">);</span>
<a name="l-6"></a>
<a name="l-7"></a>            <span class="nv">$where</span> <span class="o">=</span> <span class="s1">&#39;WHERE itemname &#39;</span><span class="o">.</span><span class="nv">$in_sql</span><span class="p">;</span>
<a name="l-8"></a>            <span class="nv">$options</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_sql</span><span class="p">(</span><span class="nv">$select</span><span class="o">.</span><span class="nv">$from</span><span class="o">.</span><span class="nv">$where</span><span class="p">,</span> <span class="nv">$in_params</span><span class="p">);</span>
</pre></div>

<p>Here we define the items that we're looking for.  Using item names probably isn't the tidiest way to do it, but it's good enough for now.</p>
<div class="highlight"><pre><a name="l-1"></a>            <span class="nv">$options</span> <span class="o">=</span> <span class="nx">hasconfig</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
<a name="l-2"></a>            <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;courseswithgrades&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nv">$options</span><span class="p">);</span>
<a name="l-3"></a>        <span class="p">}</span>
</pre></div>

<p>Finally we use <code>hasconfig()</code> to put asterisks on those with no stats linked to their pattern, and return the array.</p>
<h3><a name="exceptions">Exceptions</a></h3>
<ul>
<li><a href="#e_gradeitemexists">grade_item_exists_exception</a><br />
</li>
<li><a href="#e_needsconfig">needsconfig_exception</a><br />
</li>
<li><a href="#e_nodataforstudent">no_data_for_student_exception</a><br />
</li>
<li><a href="#e_nomtgforstudent">no_mtg_for_student_exception</a><br />
</li>
<li><a href="#e_nostudents">no_students_exception</a><br />
</li>
<li><a href="#e_unsaferegex">unsafe_regex_exception</a> </li>
</ul>
<h4><a name="e_nostudents">no_students_exception</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">class</span> <span class="nc">no_students_exception</span> <span class="k">extends</span> <span class="nx">\Exception</span> <span class="p">{}</span>
</pre></div>

<p>This exception is thrown in <code>distribute.php</code> to indicate that there are no students in a class, and therefore the process doesn't need to continue.</p>
<h4><a name="e_nodataforstudent">no_data_for_student_exception</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">class</span> <span class="nc">no_data_for_student_exception</span> <span class="k">extends</span> <span class="nx">\Exception</span> <span class="p">{}</span>
</pre></div>

<p>This exception is thrown in <code>distribute.php</code> when a student has no Average GCSE score, and therefore no grade can be calculated.</p>
<h4><a name="e_nomtgforstudent">no_mtg_for_student_exception</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">class</span> <span class="nc">no_mtg_for_student_exception</span> <span class="k">extends</span> <span class="nx">\Exception</span> <span class="p">{}</span>
</pre></div>

<p>This exception is thrown by <code>calulate_mtg()</code> to indicate that no Target Grade could be calculated   <br />
</p>
<h4><a name="e_gradeitemexists">grade_item_exists_exception</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">class</span> <span class="nc">grade_item_exists_exception</span> <span class="k">extends</span> <span class="nx">\Exception</span> <span class="p">{</span>
<a name="l-2"></a>    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>
<a name="l-3"></a>
<a name="l-4"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nv">$id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="l-5"></a>        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="nv">$code</span><span class="p">);</span>
<a name="l-6"></a>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">=</span> <span class="nv">$id</span><span class="p">;</span>
<a name="l-7"></a>    <span class="p">}</span>
<a name="l-8"></a>
<a name="l-9"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span> <span class="p">{</span>
<a name="l-10"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
<a name="l-11"></a>    <span class="p">}</span>
<a name="l-12"></a><span class="p">}</span>
</pre></div>

<p>This exception is thrown in <code>distribute.php</code> when a grade item already exists on a page.  It captures the ID of the item's record, which is used instead of the insert ID from the new record, which would be used if a new item was created.</p>
<h4><a name="e_unsaferegex">unsafe_regex_exception</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">class</span> <span class="nc">unsafe_regex_exception</span> <span class="k">extends</span> <span class="nx">\Exception</span> <span class="p">{</span>
<a name="l-2"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span> <span class="p">{</span>
<a name="l-3"></a>        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="s1">&#39;unsaferegex&#39;</span><span class="p">);</span>
<a name="l-4"></a>    <span class="p">}</span>
<a name="l-5"></a><span class="p">}</span>
</pre></div>

<p>As the <code>exclude_regex</code> config settings allows the admin user to define a regex which is executed on the server, there are checks throughout the system to ensure that the pattern entered doesn't represent a risk of <a href="http://en.wikipedia.org/wiki/ReDoS">ReDOS</a> (AKA "Catastrophic Backtracking").  This exception is thrown if such a risk is detected, to prevent the pattern being executed.</p>
<h4><a name="e_needsconfig">needsconfig_exception</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">class</span> <span class="nc">needsconfig_exception</span> <span class="k">extends</span> <span class="nx">\Exception</span> <span class="p">{}</span>
</pre></div>

<p>This exception is thrown by the plugin's pages if the plugin hasn't been configured correctly.</p>
<h3><a name="forms">Forms</a></h3>
<h4><a name="alisdata_form">alisdata_upload_form</a></h4>
<div class="highlight"><pre><a name="l-1"></a><span class="k">class</span> <span class="nc">alisdata_upload_form</span> <span class="k">extends</span> <span class="nx">moodleform</span> <span class="p">{</span>
<a name="l-2"></a>
<a name="l-3"></a>    <span class="sd">/**</span>
<a name="l-4"></a><span class="sd">     * Define the form for uploading the ALIS data as a CSV file. </span>
<a name="l-5"></a><span class="sd">     */</span>
<a name="l-6"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">definition</span><span class="p">()</span> <span class="p">{</span>
<a name="l-7"></a>        <span class="nv">$mform</span>    <span class="o">=&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_form</span><span class="p">;</span>
<a name="l-8"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="s1">&#39;blah&#39;</span><span class="p">,</span> <span class="s1">&#39;blah&#39;</span><span class="p">);</span>
<a name="l-9"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;filepicker&#39;</span><span class="p">,</span> <span class="s1">&#39;equationsfile&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;equationsfile&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-10"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;filedesc&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;equationsfiledesc&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-11"></a>        <span class="nv">$mform</span><span class="o">-&gt;</span><span class="na">addElement</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;upload&#39;</span><span class="p">));</span>
<a name="l-12"></a>    <span class="p">}</span>
<a name="l-13"></a><span class="p">}</span>
</pre></div>

<p>This form is displayed and processed by <code>alisdata_form.php</code>. It just displays a filepicker element with some explanation of the correct file format, allowing a CSV file of ALIS statistics to be uploaded.  Note that this class is not in the reporttargetgrades namespace as doing so cases problems with the <tt>moodleform</tt> class's Cross-site request forgery protection.
</body>
</html></p>