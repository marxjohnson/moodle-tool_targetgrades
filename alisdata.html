<p><html>
    <head>
        <link href="pyg.css" type="text/css" rel="stylesheet" />
        <title>Target Grades - Uploading ALIS Data</title>
    </head>
    <body></p>
<h1>Target Grades</h1>
<h2>Uploading ALIS data</h2>
<p><code>alisdata.php</code> performs 2 functions: The first is the display and handling of the <a href="libraries.html#forms"><code>alisdata_upload_form</code></a> allowing a user to upload ALIS statistics from a CSV file.  The second is display and handling of a table of statistics, allowing the user to associate the statistics with sets of courses.</p>
<ul>
<li><a href="#output">Page Output</a><br />
</li>
<li><a href="#pattern_process">Processing submitted patterns</a><br />
</li>
<li><a href="#table">Statistics Table</a><br />
</li>
<li><a href="#uploadform">Upload Form</a> </li>
</ul>
<h3><a name="output">Page Output</a></h3>
<div class="highlight"><pre><a name="l-1"></a><span class="k">echo</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">header</span><span class="p">();</span>
<a name="l-2"></a><span class="nx">tg\print_tabs</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a name="l-3"></a>
<a name="l-4"></a><span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">tag</span><span class="p">(</span><span class="s1">&#39;h2&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;alisdata&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-5"></a><span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">tag</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;configalis&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-6"></a><span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$output</span><span class="p">))</span> <span class="p">{</span>
<a name="l-7"></a>    <span class="k">echo</span> <span class="nv">$output</span><span class="p">;</span>
<a name="l-8"></a><span class="p">}</span>
<a name="l-9"></a><span class="nv">$uploadform</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">();</span>
<a name="l-10"></a><span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$table</span><span class="p">))</span> <span class="p">{</span>
<a name="l-11"></a>    <span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">tag</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;explainpatterns&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nv">$config</span><span class="p">));</span>
<a name="l-12"></a>    <span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">start_tag</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$PAGE</span><span class="o">-&gt;</span><span class="na">url</span><span class="o">-&gt;</span><span class="na">out</span><span class="p">(),</span> <span class="s1">&#39;method&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;post&#39;</span><span class="p">));</span>
<a name="l-13"></a>    <span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">table</span><span class="p">(</span><span class="nv">$table</span><span class="p">);</span>
<a name="l-14"></a>    <span class="nv">$attrs</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;savepatterns&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span> <span class="o">=&gt;</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;savechanges&#39;</span><span class="p">));</span>
<a name="l-15"></a>    <span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="nv">$attrs</span><span class="p">);</span>
<a name="l-16"></a>    <span class="k">echo</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">end_tag</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">);</span>
<a name="l-17"></a><span class="p">}</span>
<a name="l-18"></a><span class="k">echo</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">footer</span><span class="p">();</span>
</pre></div>

<p>Here you can see the page outputs the form, and if data has been uploaded, a table wrapped in a second form.  The elements for this second form are defined within the table.</p>
<h3><a name="uploadform">Upload Form</a></h3>
<div class="highlight"><pre><a name="l-1"></a><span class="nv">$uploadform</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">alisdata_upload_form</span><span class="p">();</span>
<a name="l-2"></a><span class="nv">$uploaddata</span> <span class="o">=</span> <span class="nv">$uploadform</span><span class="o">-&gt;</span><span class="na">get_data</span><span class="p">();</span>
<a name="l-3"></a>
<a name="l-4"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$uploaddata</span><span class="p">)</span> <span class="p">{</span>
<a name="l-5"></a>    <span class="nv">$handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tg\csvhandler</span><span class="p">(</span><span class="nv">$uploaddata</span><span class="o">-&gt;</span><span class="na">equationsfile</span><span class="p">);</span>
<a name="l-6"></a>    <span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">();</span>
<a name="l-7"></a>    <span class="nv">$import</span> <span class="o">=</span> <span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">process</span><span class="p">();</span>
<a name="l-8"></a>
<a name="l-9"></a>    <span class="nv">$output</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt;&#39;</span><span class="o">.</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;importoutput&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nv">$import</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">;</span>
<a name="l-10"></a>
<a name="l-11"></a><span class="p">}</span>
</pre></div>

<p>Before any output is generated, this is the only other code in this page pertaining to the upload form.  Here we initialise the object, check if a file's been submitted, and if it has pass it off to a <a href="libraries.html#csvhandler"><code>csvhandler</code></a> object for processing.</p>
<h3><a name="table">Statistics Table</a></h3>
<div class="highlight"><pre><a name="l-1"></a><span class="nv">$select</span> <span class="o">=</span> <span class="s1">&#39;SELECT a.*, a.name AS subject, q.name AS qualification &#39;</span><span class="p">;</span>
<a name="l-2"></a><span class="nv">$from</span> <span class="o">=</span> <span class="s1">&#39;FROM {report_targetgrades_alisdata} a</span>
<a name="l-3"></a><span class="s1">    JOIN {report_targetgrades_qualtype} q ON a.qualtypeid = q.id &#39;</span><span class="p">;</span>
<a name="l-4"></a><span class="nv">$order</span> <span class="o">=</span> <span class="s1">&#39;ORDER BY q.name, a.name ASC&#39;</span><span class="p">;</span>
<a name="l-5"></a>
<a name="l-6"></a><span class="k">if</span><span class="p">(</span><span class="nv">$alis_data</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records_sql</span><span class="p">(</span><span class="nv">$select</span><span class="o">.</span><span class="nv">$from</span><span class="o">.</span><span class="nv">$order</span><span class="p">))</span> <span class="p">{</span>
<a name="l-7"></a>
<a name="l-8"></a>    <span class="nv">$table</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">html_table</span><span class="p">();</span>
<a name="l-9"></a>
<a name="l-10"></a>    <span class="nv">$helpicon</span> <span class="o">=</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">help_icon</span><span class="p">(</span><span class="s1">&#39;col_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-11"></a>    <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">head</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;col_qualtype&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-12"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;col_name&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-13"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;col_pattern&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-14"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;col_gradient&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-15"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;col_intercept&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">),</span>
<a name="l-16"></a>            <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;col_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">)</span><span class="o">.</span><span class="nv">$helpicon</span><span class="p">);</span>
</pre></div>

<p>If there are ALIS statistics in the database, we want to display the table showing the statistics, indications of their quality, and fields allowing them to be associated with courses.</p>
<p>We start off by creating column headings, including a help button explaining what the quality indicators mean.</p>
<div class="highlight"><pre><a name="l-1"></a>    <span class="k">try</span> <span class="p">{</span>
<a name="l-2"></a>        <span class="nv">$options</span> <span class="o">=</span> <span class="nx">tg\build_pattern_options</span><span class="p">();</span>
<a name="l-3"></a>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">unsafe_regex_exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<a name="l-4"></a>        <span class="nx">print_error</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-5"></a>    <span class="p">}</span>
</pre></div>

<p>Next we get the course name patterns that we want to be available for association with statistics.  These are generated by <a href="libraries.html#build_pattern_options"><code>build_pattern_options</code></a>.</p>
<div class="highlight"><pre><a name="l-1"></a>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$alis_data</span> <span class="k">as</span> <span class="nv">$alis</span><span class="p">)</span> <span class="p">{</span>
<a name="l-2"></a>        <span class="nv">$form</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</pre></div>

<p>Now, we loop over each set of statistics and create a row in the table for each.</p>
<div class="highlight"><pre><a name="l-1"></a>        <span class="k">if</span><span class="p">(</span><span class="nv">$patterns</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_records</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_patterns&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;alisdataid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)))</span> <span class="p">{</span>
<a name="l-2"></a>            <span class="nv">$break</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="l-3"></a>            
<a name="l-4"></a>            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$patterns</span> <span class="k">as</span> <span class="nv">$pattern</span><span class="p">)</span> <span class="p">{</span>
<a name="l-5"></a>                <span class="nv">$optionswithpattern</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$options</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$pattern</span><span class="o">-&gt;</span><span class="na">pattern</span> <span class="o">=&gt;</span> <span class="nv">$pattern</span><span class="o">-&gt;</span><span class="na">pattern</span><span class="p">));</span>
<a name="l-6"></a>                <span class="nb">asort</span><span class="p">(</span><span class="nv">$optionswithpattern</span><span class="p">);</span>
<a name="l-7"></a>                <span class="nv">$selectname</span> <span class="o">=</span> <span class="s1">&#39;alispatterns[&#39;</span><span class="o">.</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="o">.</span><span class="s1">&#39;][&#39;</span><span class="o">.</span><span class="nv">$pattern</span><span class="o">-&gt;</span><span class="na">id</span><span class="o">.</span><span class="s1">&#39;]&#39;</span><span class="p">;</span>
<a name="l-8"></a>                <span class="nv">$form</span> <span class="o">.=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="nv">$optionswithpattern</span><span class="p">,</span> <span class="nv">$selectname</span><span class="p">,</span> <span class="nv">$pattern</span><span class="o">-&gt;</span><span class="na">pattern</span><span class="p">);</span>
<a name="l-9"></a>                <span class="k">if</span><span class="p">((</span><span class="nb">count</span><span class="p">(</span><span class="nv">$patterns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$break</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$patterns</span><span class="p">))</span> <span class="o">||</span> <span class="nv">$addfield</span> <span class="o">==</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)</span> <span class="p">{</span>
<a name="l-10"></a>                    <span class="nv">$form</span> <span class="o">.=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">);</span>
<a name="l-11"></a>                <span class="p">}</span>
<a name="l-12"></a>                <span class="nv">$break</span><span class="o">++</span><span class="p">;</span>
<a name="l-13"></a>            <span class="p">}</span>
<a name="l-14"></a>
<a name="l-15"></a>            <span class="k">if</span> <span class="p">(</span><span class="nv">$addfield</span> <span class="o">==</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)</span> <span class="p">{</span>
<a name="l-16"></a>                <span class="nv">$form</span> <span class="o">.=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="nv">$options</span><span class="p">,</span> <span class="s1">&#39;alispatterns[&#39;</span><span class="o">.</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="o">.</span><span class="s1">&#39;][]&#39;</span><span class="p">);</span>
<a name="l-17"></a>            <span class="p">}</span>
<a name="l-18"></a>            
<a name="l-19"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-20"></a>            <span class="nv">$form</span> <span class="o">.=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="nv">$options</span><span class="p">,</span> <span class="s1">&#39;alispatterns[&#39;</span><span class="o">.</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="o">.</span><span class="s1">&#39;][]&#39;</span><span class="p">);</span>
<a name="l-21"></a>        <span class="p">}</span>
<a name="l-22"></a>
<a name="l-23"></a>        <span class="nv">$attrs</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;submit&#39;</span><span class="p">,</span> 
<a name="l-24"></a>                        <span class="s1">&#39;value&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> 
<a name="l-25"></a>                        <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;addpattern[&#39;</span><span class="o">.</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="o">.</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> 
<a name="l-26"></a>                        <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;saveandadd&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">));</span>
<a name="l-27"></a>        <span class="nv">$form</span> <span class="o">.=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="nv">$attrs</span><span class="p">);</span>
</pre></div>

<p>Each set of statistics can have one or more groups of courses associated with it.  Here, we query the database to see if any groups have already been associated with the current statistics.  If they have, we display a select box for each, with thew group selected.  If not, we just display an select without a group selected by default.</p>
<p>After the select boxes are displayed, we display a submit button.  If clicked, as well as submitting the form for processing it will flag that we want to add an extra group of courses to this set of statistics, so when the page reloads, we will get an extra select box (provided by the <code>$addfield == $alis-&gt;id</code> conditional here).</p>
<div class="highlight"><pre><a name="l-1"></a>        <span class="nv">$quality</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="l-2"></a>        <span class="nv">$quality_samplesize</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;samplesize&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;S&#39;</span><span class="p">);</span>
<a name="l-3"></a>        <span class="k">switch</span> <span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_samplesize</span><span class="p">)</span> <span class="p">{</span>
<a name="l-4"></a>            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
<a name="l-5"></a>                <span class="nv">$quality_samplesize</span><span class="o">-&gt;</span><span class="na">class</span> <span class="o">=</span> <span class="s1">&#39;ok&#39;</span><span class="p">;</span>
<a name="l-6"></a>                <span class="nv">$quality_samplesize</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">=</span> <span class="s1">&#39;oksize&#39;</span><span class="p">;</span>
<a name="l-7"></a>                <span class="nv">$quality</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$quality_samplesize</span><span class="p">;</span>
<a name="l-8"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-9"></a>            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
<a name="l-10"></a>                <span class="nv">$quality_samplesize</span><span class="o">-&gt;</span><span class="na">class</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span><span class="p">;</span>
<a name="l-11"></a>                <span class="nv">$quality_samplesize</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">=</span> <span class="s1">&#39;lowsize&#39;</span><span class="p">;</span>
<a name="l-12"></a>                <span class="nv">$quality</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$quality_samplesize</span><span class="p">;</span>
<a name="l-13"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-14"></a>            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
<a name="l-15"></a>                <span class="nv">$quality_samplesize</span><span class="o">-&gt;</span><span class="na">class</span> <span class="o">=</span> <span class="s1">&#39;vlow&#39;</span><span class="p">;</span>
<a name="l-16"></a>                <span class="nv">$quality_samplesize</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">=</span> <span class="s1">&#39;vlowsize&#39;</span><span class="p">;</span>
<a name="l-17"></a>                <span class="nv">$quality</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$quality_samplesize</span><span class="p">;</span>
<a name="l-18"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-19"></a>        <span class="p">}</span>
<a name="l-20"></a>
<a name="l-21"></a>        <span class="k">if</span><span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_correlation</span><span class="p">)</span> <span class="p">{</span>
<a name="l-22"></a>                <span class="nv">$quality</span><span class="p">[]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;correlation&#39;</span><span class="p">,</span> 
<a name="l-23"></a>                                            <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;lowcorrelation&#39;</span><span class="p">,</span> 
<a name="l-24"></a>                                            <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> 
<a name="l-25"></a>                                            <span class="s1">&#39;display&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;C&#39;</span><span class="p">);</span>
<a name="l-26"></a>        <span class="p">}</span>
<a name="l-27"></a>
<a name="l-28"></a>        <span class="nv">$quality_deviation</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;standarddeviation&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;D&#39;</span><span class="p">);</span>
<a name="l-29"></a>        <span class="k">switch</span> <span class="p">(</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">quality_deviation</span><span class="p">)</span> <span class="p">{</span>
<a name="l-30"></a>            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
<a name="l-31"></a>                <span class="nv">$quality_deviation</span><span class="o">-&gt;</span><span class="na">class</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span><span class="p">;</span>
<a name="l-32"></a>                <span class="nv">$quality_deviation</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">=</span> <span class="s1">&#39;highdeviation&#39;</span><span class="p">;</span>
<a name="l-33"></a>                <span class="nv">$quality</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$quality_deviation</span><span class="p">;</span>
<a name="l-34"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-35"></a>            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
<a name="l-36"></a>                <span class="nv">$quality_deviation</span><span class="o">-&gt;</span><span class="na">class</span> <span class="o">=</span> <span class="s1">&#39;vlow&#39;</span><span class="p">;</span>
<a name="l-37"></a>                <span class="nv">$quality_deviation</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">=</span> <span class="s1">&#39;vhighdeviation&#39;</span><span class="p">;</span>
<a name="l-38"></a>                <span class="nv">$quality</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$quality_deviation</span><span class="p">;</span>
<a name="l-39"></a>                <span class="k">break</span><span class="p">;</span>
<a name="l-40"></a>        <span class="p">}</span>
<a name="l-41"></a>        
<a name="l-42"></a>        <span class="nv">$quality_html</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="l-43"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$quality</span><span class="p">))</span> <span class="p">{</span>
<a name="l-44"></a>            <span class="k">foreach</span><span class="p">(</span><span class="nv">$quality</span> <span class="k">as</span> <span class="nv">$status</span><span class="p">)</span> <span class="p">{</span>
<a name="l-45"></a>                <span class="nv">$field</span> <span class="o">=</span> <span class="nv">$status</span><span class="o">-&gt;</span><span class="na">field</span><span class="p">;</span>
<a name="l-46"></a>                <span class="nv">$class</span> <span class="o">=</span> <span class="s1">&#39;tg_&#39;</span><span class="o">.</span><span class="nv">$status</span><span class="o">-&gt;</span><span class="na">class</span><span class="o">.</span><span class="s1">&#39;quality&#39;</span><span class="p">;</span>
<a name="l-47"></a>                <span class="nv">$title</span> <span class="o">=</span> <span class="nx">get_string</span><span class="p">(</span><span class="nv">$status</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">,</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">);</span>
<a name="l-48"></a>                <span class="nv">$quality_html</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">tag</span><span class="p">(</span><span class="s1">&#39;abbr&#39;</span><span class="p">,</span> <span class="nv">$status</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="nv">$class</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">));</span>
<a name="l-49"></a>            <span class="p">}</span>
<a name="l-50"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-51"></a>            <span class="nv">$src</span> <span class="o">=</span> <span class="nv">$OUTPUT</span><span class="o">-&gt;</span><span class="na">pix_url</span><span class="p">(</span><span class="s1">&#39;i/tick_green_big&#39;</span><span class="p">);</span>
<a name="l-52"></a>            <span class="nv">$title</span> <span class="o">=</span> <span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;okquality&#39;</span><span class="p">,</span> <span class="s1">&#39;report_targetgrades&#39;</span><span class="p">);</span>
<a name="l-53"></a>            <span class="nv">$quality_html</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">empty_tag</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;src&#39;</span> <span class="o">=&gt;</span> <span class="nv">$src</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">));</span>
<a name="l-54"></a>        <span class="p">}</span>
</pre></div>

<p>Here we look at any quality flags against this set of statistics.  If there are any, we add them to an array which will display a character for each, in a colour to represent the severity of the flag.  The "OK" class displays in green, "low" displays amber, and "vlow" displays red.  If there are no flags against the statistics, a tick is displayed instead.</p>
<div class="highlight"><pre><a name="l-1"></a>        <span class="nv">$row</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">html_table_row</span><span class="p">;</span>
<a name="l-2"></a>        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">qualification</span><span class="p">;</span>
<a name="l-3"></a>        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">html_writer</span><span class="o">::</span><span class="na">tag</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">subject</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;alis&#39;</span><span class="o">.</span><span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">));</span>
<a name="l-4"></a>
<a name="l-5"></a>        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$form</span><span class="p">;</span>
<a name="l-6"></a>        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">gradient</span><span class="p">;</span>
<a name="l-7"></a>        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$alis</span><span class="o">-&gt;</span><span class="na">intercept</span><span class="p">;</span>
<a name="l-8"></a>        <span class="nv">$row</span><span class="o">-&gt;</span><span class="na">cells</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$quality_html</span><span class="p">);</span>
<a name="l-9"></a>        <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
<a name="l-10"></a>    <span class="p">}</span>
<a name="l-11"></a><span class="p">}</span>
</pre></div>

<p>Once we know everything we want on this row, we build an <code>html_table_row</code> with all the data, and add it to the <code>$table</code> object, which is rendered later with <code>html_writer</code>.</p>
<h3><a name="pattern_process">Processing submitted patterns</a></h3>
<div class="highlight"><pre><a name="l-1"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$savepatterns</span> <span class="o">||</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$addpattern</span><span class="p">))</span> <span class="p">{</span>
<a name="l-2"></a>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$alispatterns</span> <span class="k">as</span> <span class="nv">$alisid</span> <span class="o">=&gt;</span> <span class="nv">$patterns</span><span class="p">)</span> <span class="p">{</span>
<a name="l-3"></a>        <span class="k">foreach</span><span class="p">(</span><span class="nv">$patterns</span> <span class="k">as</span> <span class="nv">$id</span> <span class="o">=&gt;</span> <span class="nv">$pattern</span><span class="p">)</span> <span class="p">{</span>
<a name="l-4"></a>            <span class="k">if</span> <span class="p">(</span><span class="nv">$alisdata</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_alisdata&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$alisid</span><span class="p">)))</span> <span class="p">{</span>
<a name="l-5"></a>                <span class="k">if</span><span class="p">(</span><span class="nv">$patternrecord</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">get_record</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_patterns&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">)))</span> <span class="p">{</span>
<a name="l-6"></a>                    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">))</span> <span class="p">{</span>
<a name="l-7"></a>                        <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">delete_records</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_patterns&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span>
<a name="l-8"></a>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="l-9"></a>                        <span class="nv">$patternrecord</span><span class="o">-&gt;</span><span class="na">pattern</span> <span class="o">=</span> <span class="nv">$pattern</span><span class="p">;</span>
<a name="l-10"></a>                        <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">update_record</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_patterns&#39;</span><span class="p">,</span> <span class="nv">$patternrecord</span><span class="p">);</span>
<a name="l-11"></a>                    <span class="p">}</span>
<a name="l-12"></a>                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">))</span> <span class="p">{</span>
<a name="l-13"></a>                    <span class="nv">$patternrecord</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">;</span>
<a name="l-14"></a>                    <span class="nv">$patternrecord</span><span class="o">-&gt;</span><span class="na">alisdataid</span> <span class="o">=</span> <span class="nv">$alisid</span><span class="p">;</span>
<a name="l-15"></a>                    <span class="nv">$patternrecord</span><span class="o">-&gt;</span><span class="na">pattern</span> <span class="o">=</span> <span class="nv">$pattern</span><span class="p">;</span>
<a name="l-16"></a>                    <span class="nv">$patternrecord</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">=</span> <span class="nv">$DB</span><span class="o">-&gt;</span><span class="na">insert_record</span><span class="p">(</span><span class="s1">&#39;report_targetgrades_patterns&#39;</span><span class="p">,</span> <span class="nv">$patternrecord</span><span class="p">);</span>
<a name="l-17"></a>                <span class="p">}</span>
<a name="l-18"></a>            <span class="p">}</span>
<a name="l-19"></a>        <span class="p">}</span>
<a name="l-20"></a>    <span class="p">}</span>
<a name="l-21"></a>    <span class="nv">$output</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt;&#39;</span><span class="o">.</span><span class="nx">get_string</span><span class="p">(</span><span class="s1">&#39;changessaved&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">;</span>
<a name="l-22"></a>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$addpattern</span><span class="p">))</span> <span class="p">{</span>
<a name="l-23"></a>        <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;addfield&#39;</span> <span class="o">=&gt;</span> <span class="nb">key</span><span class="p">(</span><span class="nv">$addpattern</span><span class="p">));</span>
<a name="l-24"></a>        <span class="nx">redirect</span><span class="p">(</span><span class="k">new</span> <span class="nx">moodle_url</span><span class="p">(</span><span class="s1">&#39;/admin/report/targetgrades/alisdata.php#alis&#39;</span><span class="o">.</span><span class="nb">key</span><span class="p">(</span><span class="nv">$addpattern</span><span class="p">),</span> <span class="nv">$params</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="l-25"></a>    <span class="p">}</span>
<a name="l-26"></a><span class="p">}</span>
</pre></div>

<p>After the form containing the table is submitted, we loop though each set of statistics to see if it had any patterns added or changed, and update the database accordingly.
If the form was submitted by clicking one of the <code>+</code> buttons, once the data is processed we redirect back to this page, with a flag indicating that we want a new field, and an anchor to take us straight to it.</p>